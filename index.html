<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>地圖 v4.2.20</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* 全局和基本佈局樣式 */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Inter', sans-serif;
      color: #333;
    }
    body {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background-color: #f0f2f5;
    }

    /* 標題區域樣式 */
    #title {
      text-align: center;
      padding: 12px;
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(135deg, #6dd5ed, #2193b0);
      color: white;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      border-bottom-left-radius: 12px;
      border-bottom-right-radius: 12px;
      position: relative;
      z-index: 1001; /* 確保在其他內容之上 */
    }

    /* 編輯按鈕樣式 */
    #editButton {
      position: absolute;
      top: 50%;
      right: 15px;
      transform: translateY(-50%);
      background-color: #f0f0f0;
      color: #333;
      padding: 8px 15px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      z-index: 1003; /* 確保在標題之上 */
    }
    #editButton:hover {
      background-color: #e0e0e0;
      transform: translateY(-50%) scale(1.03);
      box-shadow: 0 4px 8px rgba(0,0,0,0.25);
    }

    /* 認證面板樣式 (預設隱藏，點擊編輯按鈕顯示) */
    #authSection {
      background: #fff;
      padding: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border-bottom: 1px solid #eee;
      display: none; /* 預設隱藏 */
      flex-direction: column;
      gap: 15px;
      position: relative;
      z-index: 1001; /* 確保在 controls 之上 */
    }
    #authSection h3 {
      margin: 0;
      font-size: 22px;
      color: #333;
      text-align: center;
    }
    #authSection input {
      padding: 10px 12px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #dcdcdc;
      width: calc(100% - 24px); /* 考慮 padding */
      box-sizing: border-box;
    }
    #loginForm, #loggedInDashboard {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    #loggedInDashboard {
        text-align: center;
    }
    #userEmailDisplay {
        font-size: 18px;
        font-weight: 600;
        color: #2193b0;
        margin-bottom: 5px;
        text-align: center;
    }

    /* KML 管理區塊內的樣式 */
    #kmlControlsDashboard, #registrationSettingsSection, #userManagementSection {
        border-top: 1px solid #eee;
        padding-top: 10px;
        margin-top: 10px;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    /* 上傳和刪除按鈕佈局 */
    #uploadKmlSectionDashboard, #deleteKmlSectionDashboard {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 8px;
    }
    #uploadKmlSectionDashboard label, #deleteKmlSectionDashboard label {
        font-size: 14px;
        font-weight: 500;
        white-space: nowrap;
        flex-shrink: 0;
    }
    #selectedKmlFileNameDashboard {
        flex-grow: 1;
        font-size: 14px;
        color: #555;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        border: 1px solid #dcdcdc;
        padding: 8px 10px;
        border-radius: 6px;
        background-color: #f9f9f9;
        transition: border-color 0.3s, box-shadow 0.3s;
        box-sizing: border-box;
        height: 36px;
        display: flex;
        align-items: center;
        cursor: pointer;
    }
    #selectedKmlFileNameDashboard:hover {
        border-color: #4a90e2;
        box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
    }

    /* 上傳和刪除按鈕寬度 */
    #uploadKmlSubmitBtnDashboard, #deleteSelectedKmlBtn {
        width: 80px;
        flex-shrink: 0;
    }

    /* 註冊碼顯示區域的彈性佈局 */
    .registration-code-display-group {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: nowrap;
    }
    .registration-code-display-group button {
        flex-shrink: 0;
        width: auto;
    }
    .registration-code-content-wrapper {
        display: flex;
        flex-grow: 1;
        align-items: center;
        gap: 5px;
        background-color: #e6f0ff;
        padding: 8px;
        border-radius: 5px;
        overflow: hidden;
    }
    #registrationCodeDisplay {
        word-break: break-all;
        text-align: center;
        flex-grow: 1;
        user-select: text;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    #registrationCodeCountdown {
        font-weight: bold;
        color: #007bff;
        white-space: nowrap;
        min-width: 80px;
        text-align: right;
        flex-shrink: 0;
    }

    /* 控制面板樣式 (預設顯示) */
    #controls {
      padding: 15px;
      background: #fff;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      display: flex; /* 預設顯示 */
      flex-direction: column;
      gap: 10px;
      position: relative; /* 為了 searchResults 絕對定位 */
      z-index: 1000;
    }

    /* KML 控制項預設是隱藏的，由 JS 控制顯示 */
    #kmlControls {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* 輸入框統一樣式 */
    #kmlInput, #searchBox, #kmlLayerSelect, #kmlLayerSelectDashboard, #registrationCodeInput, #nicknameInput {
      padding: 10px 12px;
      font-size: 15px;
      border-radius: 8px;
      border: 1px solid #dcdcdc;
      transition: border-color 0.3s, box-shadow 0.3s;
      width: calc(100% - 24px);
      box-sizing: border-box;
    }
    #kmlInput:focus, #searchBox:focus, #kmlLayerSelect:focus, #kmlLayerSelectDashboard:focus, #registrationCodeInput:focus, #nicknameInput:focus {
      border-color: #4a90e2;
      box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
      outline: none;
    }

    /* 搜尋容器樣式 */
    #searchContainer {
      display: flex;
      align-items: center;
      gap: 8px;
      border: 1px solid #dcdcdc;
      border-radius: 8px;
      padding: 0 12px;
      background-color: #fff;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
      position: relative; /* 為了 searchResults 絕對定位 */
    }

    /* Material Symbols 圖標樣式 */
    .material-symbols-outlined {
      font-variation-settings:
        'FILL' 0,
        'wght' 400,
        'GRAD' 0,
        'opsz' 24;
      font-size: 24px;
      color: #777;
      flex-shrink: 0;
      vertical-align: middle;
    }

    /* 搜尋框樣式 */
    #searchBox {
      flex-grow: 1;
      padding: 10px 0;
      border: none;
      outline: none;
      background: transparent;
      box-sizing: border-box;
      height: 44px;
    }

    /* 搜尋結果彈出框樣式 */
    #searchResults {
      position: absolute;
      top: 0; /* 將由 JS 動態調整 */
      left: 0; /* 將由 JS 動態調整 */
      width: auto; /* 將由 JS 動態調整 */
      max-height: 300px;
      background: rgba(255, 255, 255, 0.98);
      overflow-y: auto;
      border: 1px solid #ddd;
      border-top: none;
      border-bottom-left-radius: 8px;
      border-bottom-right-radius: 8px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.18);
      font-size: 15px;
      display: none; /* 預設隱藏 */
      z-index: 1100; /* 確保在最上層 */
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); /* 顯示三欄 */
      gap: 8px;
      padding: 10px;
      box-sizing: border-box;
    }
    .result-item {
      padding: 10px 12px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      background: #fdfdfd;
      cursor: pointer;
      user-select: none;
      text-align: center;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      transition: background-color 0.2s, transform 0.2s;
    }
    .result-item:hover {
      background-color: #e6f0ff;
      transform: translateY(-2px);
    }

    /* 地圖容器樣式 */
    #map {
      flex-grow: 1;
      border-radius: 12px;
      overflow: hidden;
      margin: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    /* Leaflet 控制項容器樣式 */
    .leaflet-control-container .leaflet-top.leaflet-left {
        display: flex;
        flex-direction: column; /* 將縮放和定位按鈕堆疊 */
        align-items: flex-start;
        gap: 8px; /* 按鈕間距 */
    }

    /* 地標文字標籤樣式 */
    .marker-label {
      background: none !important;
      color: rgba(0, 0, 0, 0.88);
      font-weight: 700;
      font-size: 26px;
      text-shadow:
        -1.5px -1.5px 0 #fff,
        1.5px -1.5px 0 #fff,
        -1.5px 1.5px 0 #fff,
        1.5px 1.5px 0 #fff,
        0 0 5px rgba(0,0,0,0.1);
      padding: 0;
      transform: translate(-50%, -50%);
      pointer-events: none;
      white-space: nowrap;
      display: block;
    }

    /* 導航按鈕圖標容器樣式 */
    .nav-button-icon {
        pointer-events: auto;
        background: none;
        border: none;
        box-shadow: none;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        transform: translate(-50%, -100%); /* 稍微向上移動，避免遮擋地標 */
        z-index: 999; /* 確保在標籤之上 */
    }

    /* 導航按鈕實際內容 (圖片) 樣式 */
    .nav-button-content img {
      width: 50px;
      height: 50px;
      cursor: pointer;
      display: block;
      border-radius: 50%;
      background-color: rgba(255, 255, 255, 0.9);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      transition: transform 0.2s ease-in-out;
    }
    .nav-button-content img:hover {
      transform: scale(1.1);
    }

    /* 自定義圓點圖標樣式 */
    .custom-dot-icon {
        background-color: #e74c3c; /* 紅點 */
        border: 2px solid white;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        pointer-events: auto;
        display: block;
        margin-left: -9px;
        margin-top: -9px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    /* 訊息框和註冊模態框樣式 */
    .message-box-overlay, .registration-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .message-box-overlay.visible, .registration-modal-overlay.visible {
        opacity: 1;
        visibility: visible;
    }
    .message-box-content, .registration-modal-content {
        background: #fff;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        text-align: center;
        max-width: 400px;
        width: 90%;
        transform: translateY(-20px);
        transition: transform 0.3s ease;
    }
    .message-box-overlay.visible .message-box-content,
    .registration-modal-overlay.visible .registration-modal-content {
        transform: translateY(0);
    }
    .message-box-content h3, .registration-modal-content h3 {
        margin-top: 0;
        color: #333;
        font-size: 22px;
        margin-bottom: 15px;
    }
    .message-box-content p, .registration-modal-content p {
        color: #555;
        font-size: 16px;
        line-height: 1.6;
        margin-bottom: 25px;
    }
    .message-box-content button, .registration-modal-content button {
        background-color: #4a90e2;
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: background-color 0.2s, transform 0.2s;
    }
    .message-box-content button:hover, .registration-modal-content button:hover {
        background-color: #357ABD;
        transform: translateY(-1px);
    }
    .registration-modal-content input[type="text"] {
        padding: 10px 12px;
        font-size: 15px;
        border-radius: 8px;
        border: 1px solid #dcdcdc;
        transition: border-color 0.3s, box-shadow 0.3s;
        width: calc(100% - 24px);
        box-sizing: border-box;
        margin-bottom: 15px;
    }
    .registration-modal-content .button-group {
        display: flex;
        justify-content: center;
        gap: 15px;
    }

    /* 通用操作按鈕樣式 */
    .action-buttons, .admin-option-button {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      transition: background-color 0.2s, transform 0.2s;
      width: 100%;
      box-sizing: border-box;
    }
    .action-buttons:hover, .admin-option-button:hover {
      transform: translateY(-1px);
    }
    .action-buttons:disabled, .admin-option-button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    /* 各類特定按鈕樣式 */
    .action-buttons.google-btn {
      background-color: #4285F4;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .action-buttons.google-btn img {
      width: 20px;
      height: 20px;
    }
    .action-buttons.upload-btn {
      background-color: #007bff;
    }
    .action-buttons.delete-btn {
      background-color: #dc3545;
    }

    /* 管理員選項按鈕 (Dashboard 內部按鈕) */
    .admin-option-button.upload-kml-dashboard-btn {
        background-color: #007bff;
    }
    .admin-option-button.delete-kml-dashboard-btn {
        background-color: #dc3545;
    }
    .admin-option-button.add-user-dashboard-btn {
        background-color: #17a2b8;
    }
    .admin-option-button.add-user-dashboard-btn:hover {
        background-color: #138496;
    }

    /* 新增用戶區塊樣式 */
    #addUserSection {
        border-top: 1px solid #eee;
        padding-top: 15px;
        margin-top: 15px;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    #addUserSection h4 {
        margin-top: 0;
        margin-bottom: 5px;
        font-size: 18px;
        color: #555;
    }

    /* 自定義定位按鈕樣式 */
    .leaflet-control-locate-me {
        background-color: #fff;
        border-radius: 4px;
        box-shadow: 0 1px 5px rgba(0,0,0,0.65);
        padding: 0;
        cursor: pointer;
        text-align: center;
        line-height: 28px;
        width: 30px;
        height: 30px;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: background-color 0.2s, box-shadow 0.2s;
    }
    .leaflet-control-locate-me:hover {
        background-color: #f4f4f4;
        box-shadow: 0 1px 5px rgba(0,0,0,0.8);
    }
    .leaflet-control-locate-me a {
        display: block;
        width: 100%;
        height: 100%;
        text-decoration: none;
        color: #333;
        font-size: 20px;
    }

    /* 用戶位置點樣式 (脈衝動畫) */
    .user-location-dot {
        background-color: #1a73e8;
        border: 2px solid white;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.4);
        animation: pulse 1.5s infinite ease-out;
    }
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(26, 115, 232, 0.4);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(26, 115, 232, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(26, 115, 232, 0);
        }
    }

    /* 用戶列表樣式 */
    #userList {
        display: flex;
        flex-direction: column;
        gap: 10px;
        font-size: 14px;
    }
    .user-card {
        background-color: #fdfdfd;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    .user-card-row-1, .user-card-row-2 {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
    }
    .user-card-row-1 .user-email {
        flex-basis: 60%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        min-width: 120px;
    }
    .user-card-row-1 .user-nickname {
        flex-basis: calc(40% - 10px);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-weight: 500;
        min-width: 80px;
    }
    .user-card-row-2 .user-role-controls {
        display: flex;
        align-items: center;
        gap: 5px;
        flex-shrink: 0;
        min-width: 100px;
    }
    .user-card-row-2 .user-role-select {
        padding: 6px 8px;
        border-radius: 6px;
        border: 1px solid #dcdcdc;
        font-size: 14px;
        flex-grow: 1;
        min-width: 80px;
    }
    .user-card-row-2 .user-actions {
        display: flex;
        gap: 8px;
        flex-grow: 1;
        justify-content: flex-end;
        flex-wrap: wrap;
    }
    .user-card-row-2 .change-role-btn,
    .user-card-row-2 .delete-user-btn {
        padding: 6px 10px;
        font-size: 14px;
        width: auto;
        flex-shrink: 0;
    }

    /* 註冊碼模態框計時器樣式 */
    #registrationModalMessage.countdown {
        font-size: 16px;
        font-weight: bold;
        color: #007bff;
    }
  </style>
</head>
<body>
  <div id="title">
    我的地圖系統 v4.2.20
    <button id="editButton">編輯</button>
  </div>

  <div id="controls">
    <div style="display: flex; gap: 10px; align-items: center;">
        <label for="kmlLayerSelect" style="font-size: 15px; font-weight: 500; white-space: nowrap;">選擇資料庫圖層:</label>
        <select id="kmlLayerSelect" style="flex-grow: 1;">
            <option value="">-- 請選擇 KML 圖層 --</option>
        </select>
    </div>
    <div id="searchContainer">
        <span class="material-symbols-outlined">search</span>
        <input type="text" id="searchBox" placeholder="搜尋地點..." autocomplete="off" />
        <div id="searchResults"></div>
    </div>
  </div>

  <div id="authSection">
    <div id="loginForm">
      <h3>請登入</h3>
      <button id="googleSignInBtn" class="action-buttons google-btn">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon" />
        使用 Google 登入
      </button>
      <p id="loginMessage" style="color: red; font-size: 14px; text-align: center; margin-top: 5px;"></p>
    </div>

    <div id="loggedInDashboard" style="display: none;">
      <h3 id="userEmailDisplay" style="text-align: center; margin-bottom: 10px;"></h3> 
      
      <div id="kmlControlsDashboard">
          <div id="uploadKmlSectionDashboard">
              <label for="hiddenKmlFileInput" style="white-space: nowrap;">上傳 KML:</label>
              <input type="file" id="hiddenKmlFileInput" accept=".kml" style="display: none;" />
              <span id="selectedKmlFileNameDashboard" style="flex-grow: 1; text-align: left;">尚未選擇檔案</span>
              <button id="uploadKmlSubmitBtnDashboard" class="action-buttons upload-btn" disabled>上傳</button>
          </div>
          <div id="deleteKmlSectionDashboard">
              <label for="kmlLayerSelectDashboard" style="white-space: nowrap;">刪除 KML:</label>
              <select id="kmlLayerSelectDashboard" style="flex-grow: 1;" disabled>
                  <option value="">-- 請選擇 KML 圖層 --</option>
              </select>
              <button id="deleteSelectedKmlBtn" class="action-buttons delete-btn">刪除</button>
          </div>
      </div>

      <div id="registrationSettingsSection" style="display: none;">
          <div class="registration-code-display-group">
            <button id="generateRegistrationCodeBtn" class="action-buttons" style="background-color: #28a745;">產生一次性註冊碼</button>
            <div class="registration-code-content-wrapper">
                <span id="registrationCodeDisplay" style="display: none;"></span> 
                <span id="registrationCodeCountdown" style="display: none;"></span>
            </div>
          </div>
          <p id="registrationExpiryDisplay" style="display: none; font-size: 12px; color: #888; text-align: center; margin-top: -5px;"></p>
      </div>

      <div id="userManagementSection" style="display: none; margin-top: 10px;">
          <button id="refreshUsersBtn" class="action-buttons" style="background-color: #17a2b8; margin-bottom: 10px;">使用者管理</button>
          <div id="userList" style="font-size: 14px;">
          </div>
      </div>

      <button id="logoutBtn" class="action-buttons" style="background-color: #f44336; margin-top: 15px;">登出</button>
    </div>
  </div>

  <div id="map"></div>

  <div id="messageBoxOverlay" class="message-box-overlay">
    <div class="message-box-content">
      <h3 id="messageBoxTitle"></h3>
      <p id="messageBoxMessage"></p>
      <button id="messageBoxCloseBtn">確定</button>
    </div>
  </div>

  <div id="registrationCodeModalOverlay" class="registration-modal-overlay">
    <div class="registration-modal-content">
      <h3>輸入註冊碼</h3>
      <p id="registrationModalMessage">請輸入管理員提供的一次性註冊碼。</p>
      <input type="text" id="registrationCodeInput" placeholder="註冊碼" />
      <input type="text" id="nicknameInput" placeholder="您的暱稱" />
      <div class="button-group" style="display: flex; justify-content: center; gap: 15px;">
          <button id="confirmRegistrationCodeBtn" class="action-buttons" style="background-color: #28a745;">確認</button>
          <button id="cancelRegistrationCodeBtn" class="action-buttons" style="background-color: #6c757d;">取消</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-omnivore/0.3.4/leaflet-omnivore.min.js"></script>

  <script>
    // ====================================================================================
    // 1. Firebase 初始化 和 全局函數
    // ====================================================================================

    // Firebase 配置 (請替換為您自己的 Firebase 專案配置)
    const firebaseConfig = {
      apiKey: "AIzaSyC-uaCnvgtYacPf_7BtwbwdDUw-WMx4d8s",
      authDomain: "kmldata-d22fb.firebaseapp.com",
      projectId: "kmldata-d22fb",
      storageBucket: "kmldata-d22fb.firebasestorage.app",
      messagingSenderId: "6673236901",
      appId: "1:6673236901:web:5aac773cbb512a14b8de4c", 
      measurementId: "G-TJFH5SXNJX" 
    };

    // 初始化 Firebase
    firebase.initializeApp(firebaseConfig);

    // 獲取 Firebase 服務實例
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // 根據 Canvas 環境提供的 __app_id 或是 Firebase 配置中的 projectId 來確定 appId
    const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
    console.log("Using App ID for Firestore path:", appId);


    // 定義 showMessage 函數以便全局使用
    window.showMessage = function(title, message, callback) {
        const messageBoxOverlay = document.getElementById('messageBoxOverlay');
        const messageBoxTitle = document.getElementById('messageBoxTitle');
        const messageBoxMessage = document.getElementById('messageBoxMessage');
        const messageBoxCloseBtn = document.getElementById('messageBoxCloseBtn');

        messageBoxTitle.textContent = title;
        messageBoxMessage.textContent = message;
        messageBoxOverlay.classList.add('visible'); // 顯示彈窗

        const closeHandler = () => {
            messageBoxOverlay.classList.remove('visible'); // 隱藏彈窗
            messageBoxCloseBtn.removeEventListener('click', closeHandler);
            if (callback) {
                callback();
            }
        };
        messageBoxCloseBtn.addEventListener('click', closeHandler);
    };

    // 定義 showRegistrationCodeModal 函數以便全局使用，增加計時器功能
    window.showRegistrationCodeModal = function(callback) {
        const modalOverlay = document.getElementById('registrationCodeModalOverlay');
        const registrationCodeInput = document.getElementById('registrationCodeInput');
        const nicknameInput = document.getElementById('nicknameInput');
        const confirmBtn = document.getElementById('confirmRegistrationCodeBtn');
        const cancelBtn = document.getElementById('cancelRegistrationCodeBtn');
        const modalMessage = document.getElementById('registrationModalMessage');

        registrationCodeInput.value = ''; // 清空註冊碼輸入框
        nicknameInput.value = ''; // 清空暱稱輸入框
        modalMessage.textContent = '請輸入管理員提供的一次性註冊碼。'; // 重設訊息
        modalMessage.classList.remove('countdown'); // 移除計時器樣式
        modalOverlay.classList.add('visible'); // 顯示模態框

        let countdown = 60; // 60秒計時
        let timerInterval;

        const updateTimer = () => {
            modalMessage.textContent = `請輸入管理員提供的一次性註冊碼。剩餘時間: ${countdown} 秒`;
            modalMessage.classList.add('countdown');
            if (countdown <= 0) {
                clearInterval(timerInterval);
                modalOverlay.classList.remove('visible'); // 隱藏模態框
                cleanupListeners();
                callback(null); // 表示時間到，自動取消
            }
            countdown--;
        };

        const cleanupListeners = () => {
            clearInterval(timerInterval);
            confirmBtn.removeEventListener('click', confirmHandler);
            cancelBtn.removeEventListener('click', cancelHandler);
        };

        const confirmHandler = () => {
            const code = registrationCodeInput.value.trim();
            const nickname = nicknameInput.value.trim();
            if (code && nickname) {
                modalOverlay.classList.remove('visible'); // 隱藏模態框
                cleanupListeners();
                callback({ code: code, nickname: nickname });
            } else {
                modalMessage.textContent = '請輸入註冊碼和您的暱稱。';
                modalMessage.classList.remove('countdown');
            }
        };

        const cancelHandler = () => {
            modalOverlay.classList.remove('visible'); // 隱藏模態框
            cleanupListeners();
            callback(null); // 表示取消
        };

        // 啟動計時器
        timerInterval = setInterval(updateTimer, 1000);
        updateTimer(); // 立即執行一次以顯示初始時間

        confirmBtn.addEventListener('click', confirmHandler);
        cancelBtn.addEventListener('click', cancelHandler);
    };

    // ====================================================================================
    // 2. 地圖應用程式邏輯
    // ====================================================================================

    let map;
    let markers = L.featureGroup(); // 用於儲存所有標記以便管理
    let navButtons = L.featureGroup(); // 用於儲存導航按鈕

    // 新增一個全局變數，用於儲存所有地圖上 KML Point Features 的數據，供搜尋使用
    window.allKmlFeatures = [];

    document.addEventListener('DOMContentLoaded', () => {
        // 初始化地圖
        map = L.map('map', { zoomControl: false }).setView([23.6, 120.9], 8); // 台灣中心經緯度，禁用預設縮放控制

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // 將縮放控制添加到地圖的左上方
        L.control.zoom({ position: 'topleft' }).addTo(map);

        // 自定義定位控制項
        const LocateMeControl = L.Control.extend({
            _userLocationMarker: null,
            _userLocationCircle: null,

            onAdd: function(map) {
                const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-locate-me');
                const button = L.DomUtil.create('a', '', container);
                button.href = "#";
                button.title = "顯示我的位置";
                button.setAttribute("role", "button");
                button.setAttribute("aria-label", "顯示我的位置");
                button.innerHTML = `<span class="material-symbols-outlined" style="font-size: 24px; line-height: 30px;">my_location</span>`;

                L.DomEvent.on(button, 'click', this._locateUser, this);

                // 為地理定位成功/失敗事件添加監聽器
                map.on('locationfound', this._onLocationFound, this);
                map.on('locationerror', this._onLocationError, this);

                return container;
            },

            onRemove: function(map) {
                map.off('locationfound', this._onLocationFound, this);
                map.off('locationerror', this._onLocationError, this);
                this._clearLocationMarkers();
            },

            _locateUser: function(e) {
                L.DomEvent.stopPropagation(e);
                L.DomEvent.preventDefault(e);

                this._clearLocationMarkers();

                // 開始定位用戶位置
                map.locate({
                    setView: true,
                    maxZoom: 16,
                    enableHighAccuracy: true,
                    watch: false
                });
                window.showMessage('定位中', '正在獲取您的位置...');
            },

            _onLocationFound: function(e) {
                this._clearLocationMarkers();

                const radius = e.accuracy / 2;

                this._userLocationMarker = L.marker(e.latlng, {
                    icon: L.divIcon({
                        className: 'user-location-dot',
                        iconSize: [16, 16],
                        iconAnchor: [8, 8]
                    })
                }).addTo(map);

                this._userLocationCircle = L.circle(e.latlng, radius, {
                    color: '#1a73e8',
                    fillColor: '#1a73e8',
                    fillOpacity: 0.15,
                    weight: 2
                }).addTo(map);

                window.showMessage('定位成功', `您的位置已定位，誤差約 ${radius.toFixed(0)} 公尺。`);
            },

            _onLocationError: function(e) {
                this._clearLocationMarkers();
                window.showMessage('定位失敗', `無法獲取您的位置: ${e.message}`);
                console.error('Geolocation error:', e.message);
            },

            _clearLocationMarkers: function() {
                if (this._userLocationMarker) {
                    map.removeLayer(this._userLocationMarker);
                    this._userLocationMarker = null;
                }
                if (this._userLocationCircle) {
                    map.removeLayer(this._userLocationCircle);
                    this._userLocationCircle = null;
                }
            }
        });

        // 將自定義定位控制項添加到地圖的左上方
        new LocateMeControl({ position: 'topleft' }).addTo(map);

        // 將 markers 和 navButtons 添加到地圖
        markers.addTo(map);
        navButtons.addTo(map);

        // 全局函數：添加標記到地圖
        window.addMarkers = function(featuresToDisplay) {
            markers.clearLayers(); // 清除現有標記

            if (!featuresToDisplay || featuresToDisplay.length === 0) {
                console.log("沒有 features 可顯示。");
                return;
            }
            console.log(`正在將 ${featuresToDisplay.length} 個標記添加到地圖。`);
            featuresToDisplay.forEach(f => {
                if (f.geometry.type === 'Point') {
                    const [lon, lat] = f.geometry.coordinates;
                    const name = f.properties.name || '未命名';
                    const labelLatLng = L.latLng(lat, lon + 0.00015);

                    // 自定義圓點圖標
                    const dotIcon = L.divIcon({
                        className: 'custom-dot-icon',
                        iconSize: [18, 18],
                        iconAnchor: [9, 9]
                    });
                    const customDotMarker = L.marker(L.latLng(lat, lon), {
                        icon: dotIcon,
                        interactive: true
                    });

                    // 永久顯示的文字標籤
                    const label = L.marker(labelLatLng, {
                        icon: L.divIcon({
                            className: 'marker-label',
                            html: `<span>${name}</span>`,
                            iconSize: [null, null],
                            iconAnchor: [0, 0],
                        }),
                        interactive: false
                    });

                    // 點擊圓點標記時創建導航按鈕
                    customDotMarker.on('click', (e) => {
                        L.DomEvent.stopPropagation(e);
                        window.createNavButton(L.latLng(lat, lon), name);
                    });

                    // 將圓點標記和文字標籤添加到 markers FeatureGroup
                    markers.addLayer(customDotMarker);
                    markers.addLayer(label);
                }
            });
        };

        // 全局函數：從 Firestore 載入 KML 圖層
        window.loadKmlLayerFromFirestore = async function(kmlId) {
            if (!kmlId) {
                console.log("未提供 KML ID，不載入。");
                window.clearAllKmlLayers();
                return;
            }

            // 移除現有 KML 圖層和所有標記 (包括導航按鈕)
            window.clearAllKmlLayers();

            try {
                // 從 Firestore 獲取 KML 文件的元數據
                const doc = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('kmlLayers').doc(kmlId).get();
                if (!doc.exists) {
                    console.error('KML 圖層文檔未找到 ID:', kmlId);
                    showMessage('錯誤', '找不到指定的 KML 圖層資料。'); 
                    return;
                }
                const kmlData = doc.data(); 

                console.log(`正在載入 KML Features，圖層名稱: ${kmlData.name || kmlId}`);

                // 從 kmlLayers/{kmlId}/features 子集合中獲取所有 GeoJSON features
                const featuresSubCollectionRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('kmlLayers').doc(kmlId).collection('features');
                const querySnapshot = await featuresSubCollectionRef.get();
                
                const loadedFeatures = [];
                if (querySnapshot.empty) {
                    console.log(`KML 圖層 "${kmlData.name}" 的 features 子集合為空。`);
                } else {
                    querySnapshot.forEach(featureDoc => {
                        const feature = featureDoc.data();
                        // 僅處理 Point 類型的 feature，並進行基本的數據驗證
                        if (feature.geometry && feature.geometry.type === 'Point' && feature.geometry.coordinates && feature.properties) {
                            loadedFeatures.push(feature);
                        } else {
                            console.warn('正在跳過來自 Firestore 的無效或非 Point 類型的 feature:', feature);
                        }
                    });
                }

                window.allKmlFeatures = loadedFeatures; // 更新全局搜尋數據
                window.addMarkers(window.allKmlFeatures); // 將地標添加到地圖

                if (window.allKmlFeatures.length > 0) {
                    // 如果有地標，設定地圖視角以包含所有地標
                    if (markers.getLayers().length > 0 && markers.getBounds().isValid()) {
                        map.fitBounds(markers.getBounds());
                    } else {
                        console.warn("標記存在，但其邊界對於地圖視圖不適用。");
                    }
                } else {
                    console.log(`KML 圖層 "${kmlData.name}" 載入完成，但沒有找到地標。`);
                }

            } catch (error) {
                console.error("獲取 KML Features 或載入 KML 時出錯:", error);
                showMessage('錯誤', `無法載入 KML 圖層: ${error.message}`);
            }
        };

        // 全局函數：清除所有 KML 圖層、標記和導航按鈕
        window.clearAllKmlLayers = function() {
            markers.clearLayers();
            navButtons.clearLayers();
            window.allKmlFeatures = [];
            console.log("所有 KML 圖層、標記和導航按鈕已清除。");
        };

        // 全局函數：創建導航按鈕
        window.createNavButton = function(latlng, name) {
            navButtons.clearLayers();

            const googleMapsUrl = `http://maps.google.com/maps?q=${latlng.lat},${latlng.lng}`; 
            
            const buttonHtml = `        
                <div class="nav-button-content" onclick="window.open('${googleMapsUrl}', '_blank'); event.stopPropagation();">          
                    <img src="https://i0.wp.com/canadasafetycouncil.org/wp-content/uploads/2018/08/offroad.png" alt="導航" />        
                </div>      
            `;      
            const buttonIcon = L.divIcon({        
                className: 'nav-button-icon',        
                html: buttonHtml,        
                iconSize: [50, 50],        
                iconAnchor: [25, 25]      
            });      
            
            const navMarker = L.marker(latlng, {
                icon: buttonIcon,        
                interactive: true      
            }).addTo(navButtons);      
            
            console.log(`已為 ${name} 在 ${latlng.lat}, ${latlng.lng} 創建導航按鈕。`);    
        };


        // 處理地圖點擊事件，隱藏搜尋結果和導航按鈕
        map.on('click', () => {
            const searchResults = document.getElementById('searchResults');
            if (searchResults) {
                searchResults.style.display = 'none';
            }
            const searchBox = document.getElementById('searchBox');
            if (searchBox) {
                searchBox.value = '';
            }
            navButtons.clearLayers();
        });
    });

    // ====================================================================================
    // 3. 身份驗證和 KML 管理邏輯
    // ====================================================================================

    document.addEventListener('DOMContentLoaded', () => {
        // 獲取所有相關的 DOM 元素
        const authSection = document.getElementById('authSection');
        const loginForm = document.getElementById('loginForm');
        const loggedInDashboard = document.getElementById('loggedInDashboard');
        const googleSignInBtn = document.getElementById('googleSignInBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginMessage = document.getElementById('loginMessage');
        const userEmailDisplay = document.getElementById('userEmailDisplay');

        const hiddenKmlFileInput = document.getElementById('hiddenKmlFileInput');
        const selectedKmlFileNameDashboard = document.getElementById('selectedKmlFileNameDashboard');
        const uploadKmlSubmitBtnDashboard = document.getElementById('uploadKmlSubmitBtnDashboard');
        const kmlLayerSelectDashboard = document.getElementById('kmlLayerSelectDashboard');
        const deleteSelectedKmlBtn = document.getElementById('deleteSelectedKmlBtn');

        const registrationSettingsSection = document.getElementById('registrationSettingsSection');
        const generateRegistrationCodeBtn = document.getElementById('generateRegistrationCodeBtn');
        const registrationCodeDisplay = document.getElementById('registrationCodeDisplay');
        const registrationCodeCountdown = document.getElementById('registrationCodeCountdown');
        const registrationExpiryDisplay = document.getElementById('registrationExpiryDisplay');

        const userManagementSection = document.getElementById('userManagementSection');
        const refreshUsersBtn = document.getElementById('refreshUsersBtn');
        const userListDiv = document.getElementById('userList');

        // 全局變數
        window.currentUserRole = null;
        let currentKmlLayers = [];
        let registrationCodeTimer = null;

        // 輔助函數：將角色英文轉換為中文
        const getRoleDisplayName = (role) => {
            switch (role) {
                case 'unapproved': return '未審核';
                case 'user': return '一般用戶';
                case 'editor': return '編輯者';
                case 'owner': return '擁有者';
                default: return role;
            }
        };

        // 輔助函數：更新 KML 圖層選單
        const updateKmlLayerSelects = async () => {
            const kmlLayerSelect = document.getElementById('kmlLayerSelect');
            kmlLayerSelect.innerHTML = '<option value="">-- 請選擇 KML 圖層 --</option>';
            const kmlLayerSelectDashboard = document.getElementById('kmlLayerSelectDashboard');
            kmlLayerSelectDashboard.innerHTML = '<option value="">-- 請選擇 KML 圖層 --</option>';
            const deleteSelectedKmlBtn = document.getElementById('deleteSelectedKmlBtn');
            if (deleteSelectedKmlBtn) deleteSelectedKmlBtn.disabled = true;

            kmlLayerSelect.disabled = false;
            
            const canEdit = (window.currentUserRole === 'owner' || window.currentUserRole === 'editor');
            if (kmlLayerSelectDashboard) kmlLayerSelectDashboard.disabled = !canEdit;
            if (uploadKmlSubmitBtnDashboard) uploadKmlSubmitBtnDashboard.disabled = !canEdit;


            try {
                const kmlRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('kmlLayers');
                let snapshot;

                if (window.currentUserRole === 'editor' && auth.currentUser && auth.currentUser.email) {
                    snapshot = await kmlRef.where('uploadedBy', '==', auth.currentUser.email).get();
                } else {
                    snapshot = await kmlRef.get();
                }

                currentKmlLayers = [];

                if (snapshot.empty) {
                    console.log("沒有 KML 圖層資料。");
                    return;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const kmlId = doc.id;
                    const kmlName = data.name || `KML_${kmlId.substring(0, 8)}`;
                    const option = document.createElement('option');
                    option.value = kmlId;
                    option.textContent = kmlName;
                    kmlLayerSelect.appendChild(option);

                    const optionDashboard = document.createElement('option');
                    optionDashboard.value = kmlId;
                    optionDashboard.textContent = kmlName;
                    kmlLayerSelectDashboard.appendChild(optionDashboard);

                    currentKmlLayers.push({ id: kmlId, name: kmlName });
                });

                if (currentKmlLayers.length > 0) {
                    if (canEdit && deleteSelectedKmlBtn) {
                        deleteSelectedKmlBtn.disabled = false; 
                    }
                }

                kmlLayerSelect.removeEventListener('change', handleKmlLayerSelectChange);
                kmlLayerSelect.addEventListener('change', handleKmlLayerSelectChange);


            } catch (error) {
                console.error("更新 KML 圖層列表時出錯:", error);
                showMessage('錯誤', '無法載入 KML 圖層列表。');
            }
        };

        // KML 層選擇器變更處理函數
        const handleKmlLayerSelectChange = (event) => {
            const kmlId = event.target.value;
            if (kmlId && typeof window.loadKmlLayerFromFirestore === 'function') {
                window.loadKmlLayerFromFirestore(kmlId);
            } else if (typeof window.clearAllKmlLayers === 'function') {
                window.clearAllKmlLayers();
            }
        };


        // 輔助函數：顯示用戶管理列表
        const refreshUserList = async () => {
            userListDiv.innerHTML = '載入中...';
            try {
                const usersRef = db.collection('users');
                const snapshot = await usersRef.get();
                userListDiv.innerHTML = '';

                if (snapshot.empty) {
                    userListDiv.innerHTML = '<p>目前沒有註冊用戶。</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const user = doc.data();
                    const uid = doc.id;
                    if (uid === auth.currentUser.uid) return;

                    const userCard = document.createElement('div');
                    userCard.className = 'user-card';
                    userCard.dataset.nickname = user.name || 'N/A';
                    userCard.dataset.uid = uid;

                    userCard.innerHTML = `
                        <div class="user-card-row-1">
                            <span class="user-email">Email: ${user.email || 'N/A'}</span>
                            <span class="user-nickname">暱稱: ${user.name || 'N/A'}</span>
                        </div>
                        <div class="user-card-row-2">
                            <div class="user-role-controls">
                                <label for="role-select-${uid}">角色:</label>
                                <select id="role-select-${uid}" data-uid="${uid}" data-original-value="${user.role}" class="user-role-select">
                                    <option value="unapproved" ${user.role === 'unapproved' ? 'selected' : ''}>${getRoleDisplayName('unapproved')}</option>
                                    <option value="user" ${user.role === 'user' ? 'selected' : ''}>${getRoleDisplayName('user')}</option>
                                    <option value="editor" ${user.role === 'editor' ? 'selected' : ''}>${getRoleDisplayName('editor')}</option>
                                    <option value="owner" ${user.role === 'owner' ? 'selected' : ''} ${window.currentUserRole !== 'owner' ? 'disabled' : ''}>${getRoleDisplayName('owner')}</option>
                                </select>
                            </div>
                            <div class="user-actions">
                                <button class="change-role-btn" data-uid="${uid}" disabled>變更</button>
                                <button class="delete-user-btn action-buttons delete-btn" data-uid="${uid}">刪除</button>
                            </div>
                        </div>
                    `;
                    userListDiv.appendChild(userCard);
                });

                userListDiv.querySelectorAll('.user-role-select').forEach(select => {
                    select.dataset.originalValue = select.value;
                    const changeButton = select.closest('.user-card').querySelector('.change-role-btn'); 
                    
                    select.addEventListener('change', (event) => {
                        changeButton.disabled = (event.target.value === select.dataset.originalValue);
                    });

                    changeButton.addEventListener('click', async (event) => {
                        const userCard = event.target.closest('.user-card');
                        const uidToUpdate = userCard.dataset.uid;
                        const nicknameToUpdate = userCard.dataset.nickname;
                        const newRole = select.value;
                        if (newRole === 'owner' && !confirm('確定要將此用戶設定為 Owner 嗎？Owner 擁有最高權限。')) {
                            return;
                        }

                        try {
                            await db.collection('users').doc(uidToUpdate).update({ role: newRole });
                            showMessage('成功', `用戶 ${nicknameToUpdate} (${uidToUpdate.substring(0,6)}...) 的角色已更新為 ${getRoleDisplayName(newRole)}。`);
                            select.dataset.originalValue = newRole;
                            changeButton.disabled = true;
                        } catch (error) {
                            console.error("更新用戶角色時出錯:", error);
                            showMessage('錯誤', `更新用戶角色失敗: ${error.message}`);
                            select.value = select.dataset.originalValue;
                            changeButton.disabled = true;
                        }
                    });
                });

                userListDiv.querySelectorAll('.delete-user-btn').forEach(button => {
                    button.addEventListener('click', async (event) => {
                        const userCard = event.target.closest('.user-card');
                        const uidToDelete = userCard.dataset.uid;
                        const nicknameToDelete = userCard.dataset.nickname;

                        if (confirm(`確定要刪除用戶 ${nicknameToDelete} (${uidToDelete.substring(0,6)}...) 嗎？此操作不可逆！`)) {
                            try {
                                await db.collection('users').doc(uidToDelete).delete();
                                showMessage('成功', `用戶 ${nicknameToDelete} (${uidToDelete.substring(0,6)}...) 已刪除（請確保在 Firebase Authentication 中也同步刪除）。`);
                                refreshUserList();
                            } catch (error) {
                                console.error("刪除用戶時出錯:", error);
                                showMessage('錯誤', `刪除用戶失敗: ${error.message}`);
                            }
                        }
                    });
                });

            } catch (error) {
                console.error("載入用戶列表時出錯:", error);
                userListDiv.innerHTML = `<p style="color: red;">載入用戶列表失敗: ${error.message}</p>`;
            }
        };


        // Firestore 實時監聽器
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                loginForm.style.display = 'none';
                loggedInDashboard.style.display = 'block';
                userEmailDisplay.textContent = user.email;
                userEmailDisplay.style.display = 'block';

                db.collection('users').doc(user.uid).onSnapshot(async (doc) => {
                    if (doc.exists) {
                        const userData = doc.data();
                        window.currentUserRole = userData.role || 'unapproved';

                        console.log("用戶角色:", window.currentUserRole);

                        const canEdit = (window.currentUserRole === 'owner' || window.currentUserRole === 'editor');
                        const isOwner = (window.currentUserRole === 'owner');

                        uploadKmlSubmitBtnDashboard.disabled = !canEdit;
                        deleteSelectedKmlBtn.disabled = !(canEdit && currentKmlLayers.length > 0);
                        kmlLayerSelectDashboard.disabled = !canEdit;

                        registrationSettingsSection.style.display = isOwner ? 'flex' : 'none'; 
                        generateRegistrationCodeBtn.disabled = !isOwner;
                        registrationCodeDisplay.style.display = 'none';
                        registrationCodeCountdown.style.display = 'none';
                        registrationExpiryDisplay.style.display = 'none';

                        userManagementSection.style.display = isOwner ? 'block' : 'none';
                        refreshUsersBtn.disabled = !isOwner;


                        if (isOwner) {
                            refreshUserList();
                        }

                        if (window.currentUserRole === 'unapproved') {
                            showMessage('帳號審核中', '您的帳號正在等待管理員審核。在審核通過之前，您將無法上傳或刪除 KML。');
                        }

                        updateKmlLayerSelects();

                    } else {
                        console.log("用戶數據不存在，為新註冊用戶創建預設數據。");
                        auth.signOut();
                        showMessage('帳號資料異常', '您的帳號資料有誤或已被移除，請重新登入或聯繫管理員。');
                    }
                }, (error) => {
                    console.error("監聽用戶角色時出錯:", error);
                    showMessage('錯誤', `獲取用戶角色失敗: ${error.message}`);
                    auth.signOut();
                });

            } else {
                loginForm.style.display = 'block';
                loggedInDashboard.style.display = 'none';
                userEmailDisplay.textContent = '';
                userEmailDisplay.style.display = 'none';
                window.currentUserRole = null;
                updateKmlLayerSelects();
            }
        });

        // 事件監聽器：Google 登入/註冊
        googleSignInBtn.addEventListener('click', async () => {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const userCredential = await auth.signInWithPopup(provider);
                const user = userCredential.user;

                const userDoc = await db.collection('users').doc(user.uid).get();
                if (!userDoc.exists) {
                    await auth.signOut();
                    window.showRegistrationCodeModal(async (result) => {
                        if (result) {
                            const code = result.code;
                            const nickname = result.nickname;

                            try {
                                const regDoc = await db.collection('settings').doc('registration').get();
                                console.log("註冊嘗試: 用戶輸入的註冊碼:", code);
                                if (regDoc.exists) {
                                    console.log("Firestore 註冊設定數據:", regDoc.data());
                                    const storedCode = regDoc.data().oneTimeCode;
                                    const expiryTime = regDoc.data().oneTimeCodeExpiry ? regDoc.data().oneTimeCodeExpiry.toDate() : null;
                                    const currentTime = new Date();
                                    console.log(`儲存的註冊碼: ${storedCode}, 過期時間: ${expiryTime}, 目前時間: ${currentTime}`);
                                    console.log(`註冊碼是否匹配: ${storedCode === code}, 是否過期: ${expiryTime && currentTime > expiryTime}`);


                                    if (!storedCode || storedCode !== code || (expiryTime && currentTime > expiryTime)) {
                                        showMessage('註冊失敗', '無效或過期的註冊碼。');
                                        console.error(`註冊失敗: 註冊碼不匹配或已過期。`);
                                        return;
                                    }
                                } else {
                                    showMessage('註冊失敗', '註冊系統未啟用或無效的註冊碼。請聯繫管理員。');
                                    console.error("settings/registration 文檔不存在。");
                                    return;
                                }
                                
                                const reAuthUserCredential = await auth.signInWithPopup(provider);
                                const reAuthUser = reAuthUserCredential.user;

                                console.log("嘗試創建新用戶文檔:", {
                                    uid: reAuthUser.uid,
                                    email: reAuthUser.email,
                                    name: nickname,
                                    role: 'unapproved',
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    registeredWithCode: true,
                                    registrationCodeUsed: code
                                });

                                await db.collection('users').doc(reAuthUser.uid).set({
                                    email: reAuthUser.email,
                                    name: nickname,
                                    role: 'unapproved',
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    registeredWithCode: true,
                                    registrationCodeUsed: code
                                });
                                console.log("新用戶文檔創建成功。");

                                showMessage('註冊成功', `歡迎 ${reAuthUser.email} (${nickname})！您的帳號已成功註冊，正在等待管理員審核。`);

                            } catch (error) {
                                console.error("使用註冊碼登入/註冊失敗:", error);
                                if (error.code) {
                                    console.error(`Firebase Error Code: ${error.code}`);
                                }
                                showMessage('註冊失敗', `使用註冊碼登入/註冊時發生錯誤: ${error.message} (請檢查安全規則)`);
                            }
                        } else {
                            showMessage('取消', '您已取消註冊。');
                        }
                    });
                } else {
                    showMessage('登入成功', `歡迎回來 ${user.email}！`);
                }
            } catch (error) {
                console.error("Google 登入失敗:", error);
                loginMessage.textContent = `登入失敗: ${error.message}`;
                showMessage('登入失敗', `Google 登入時發生錯誤: ${error.message}`);
            }
        });

        // 事件監聽器：登出
        logoutBtn.addEventListener('click', async () => {
            try {
                await auth.signOut();
                showMessage('登出成功', '您已成功登出。');
            } catch (error) {
                console.error("登出失敗:", error);
                showMessage('登出失敗', `登出時發生錯誤: ${error.message}`);
            }
        });

        // 事件監聽器：上傳 KML (Dashboard 上的按鈕，觸發文件選擇)
        uploadKmlSubmitBtnDashboard.addEventListener('click', () => {
            hiddenKmlFileInput.click();
        });

        // 監聽實際的文件選擇變化
        hiddenKmlFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                selectedKmlFileNameDashboard.textContent = file.name;
                uploadKmlSubmitBtnDashboard.disabled = false;
            } else {
                selectedKmlFileNameDashboard.textContent = '尚未選擇檔案';
                uploadKmlSubmitBtnDashboard.disabled = true;
            }
        });

        // 點擊 "尚未選擇檔案" 對話框也能選取檔案
        selectedKmlFileNameDashboard.addEventListener('click', () => {
            hiddenKmlFileInput.click();
        });


        // 實際執行上傳 KML 的函數
        uploadKmlSubmitBtnDashboard.addEventListener('click', async () => {
            const file = hiddenKmlFileInput.files[0];
            if (!file) {
                showMessage('提示', '請先選擇 KML 檔案。');
                return;
            }
            if (!auth.currentUser || (window.currentUserRole !== 'owner' && window.currentUserRole !== 'editor')) {
                showMessage('錯誤', '您沒有權限上傳 KML，請登入或等待管理員審核。');
                return;
            }

            const fileName = file.name;
            const reader = new FileReader();
            reader.onload = async () => {
                console.log(`正在處理 KML 檔案: ${file.name}`);
                try {
                    const kmlString = reader.result;
                    const parser = new DOMParser();
                    const kmlDoc = parser.parseFromString(kmlString, 'text/xml');

                    if (kmlDoc.getElementsByTagName('parsererror').length > 0) {
                        const errorText = kmlDoc.getElementsByTagName('parsererror')[0].textContent;
                        throw new Error(`KML XML 解析錯誤: ${errorText}。請確保您的 KML 檔案是有效的 XML。`);
                    }

                    const tempOmnivoreLayer = omnivore.kml(kmlDoc); 
                    if (!tempOmnivoreLayer) {
                        throw new Error("無法從解析的 XML 文檔創建 Omnivore KML 圖層。");
                    }
                    const geojson = tempOmnivoreLayer.toGeoJSON(); 
                    const parsedFeatures = geojson.features || []; 

                    console.log(`KML 檔案已解析。找到 ${parsedFeatures.length} 個 features。`);

                    if (parsedFeatures.length === 0) {
                        showMessage('KML 載入', 'KML 檔案中沒有找到任何地標 (Point features)。');
                        console.warn("KML 檔案不包含任何可用的 Point 類型 feature。");
                        return;
                    }

                    const kmlLayersCollectionRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('kmlLayers');
                    const kmlLayerDocRef = await kmlLayersCollectionRef.add({
                        name: fileName,
                        uploadTime: firebase.firestore.FieldValue.serverTimestamp(),
                        uploadedBy: auth.currentUser.email || auth.currentUser.uid,
                        uploadedByRole: window.currentUserRole
                    });

                    const featuresSubCollectionRef = kmlLayersCollectionRef.doc(kmlLayerDocRef.id).collection('features');
                    const batch = db.batch();
                    let addedCount = 0;
                    console.log(`開始批量寫入 ${parsedFeatures.length} 個 features。`);
                    for (const f of parsedFeatures) {
                        if (f.geometry && f.properties && f.geometry.type === 'Point') {
                            batch.set(featuresSubCollectionRef.doc(), {
                                geometry: f.geometry,
                                properties: f.properties
                            });
                            addedCount++;
                        } else {
                            console.warn("上傳時跳過非 Point 類型或無座標的 feature:", f.geometry ? f.geometry.type : '無幾何資訊', f);
                        }
                    }
                    await batch.commit();
                    console.log(`批量提交成功。已添加 ${addedCount} 個 features。`);

                    showMessage('成功', `KML 檔案 "${fileName}" 已成功上傳並儲存 ${addedCount} 個地標。`);
                    hiddenKmlFileInput.value = '';
                    selectedKmlFileNameDashboard.textContent = '尚未選擇檔案';
                    uploadKmlSubmitBtnDashboard.disabled = true;
                    updateKmlLayerSelects();
                } catch (error) {
                    console.error("處理 KML 檔案或上傳到 Firebase 時出錯:", error);
                    showMessage('KML 處理錯誤', `處理 KML 檔案或上傳時發生錯誤：${error.message}`);
                }
            };
            reader.readAsText(file);
        });


        // 事件監聽器：刪除 KML
        deleteSelectedKmlBtn.addEventListener('click', async () => {
            const kmlIdToDelete = kmlLayerSelectDashboard.value;
            if (!kmlIdToDelete) {
                showMessage('提示', '請先選擇要刪除的 KML 圖層。');
                return;
            }
            if (!auth.currentUser || (window.currentUserRole !== 'owner' && window.currentUserRole !== 'editor')) {
                showMessage('錯誤', '您沒有權限刪除 KML。');
                return;
            }

            if (!confirm('確定要刪除此 KML 圖層及其所有地標嗎？此操作不可逆！')) {
                return;
            }

            try {
                const kmlLayerDocRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('kmlLayers').doc(kmlIdToDelete);
                const kmlDoc = await kmlLayerDocRef.get();
                if (!kmlDoc.exists) {
                    showMessage('錯誤', '找不到該 KML 圖層。');
                    return;
                }
                const kmlData = kmlDoc.data();
                const fileName = kmlData.name;

                const featuresSubCollectionRef = kmlLayerDocRef.collection('features');
                const featuresSnapshot = await featuresSubCollectionRef.get();
                const batch = db.batch();
                let deletedFeaturesCount = 0;
                featuresSnapshot.forEach(docRef => {
                    batch.delete(docRef.ref);
                    deletedFeaturesCount++;
                });
                await batch.commit();
                console.log(`已從子集合中刪除 ${deletedFeaturesCount} 個 features。`);

                await kmlLayerDocRef.delete();
                console.log(`已刪除父 KML 圖層文檔: ${kmlIdToDelete}`);
                
                showMessage('成功', `KML 圖層 "${fileName}" 已成功刪除，共刪除 ${deletedFeaturesCount} 個地標。`);
                updateKmlLayerSelects();
                window.clearAllKmlLayers();
            } catch (error) {
                console.error("刪除 KML 失敗:", error);
                showMessage('刪除失敗', `刪除 KML 圖層時發生錯誤: ${error.message}`);
            }
        });

        // Function to generate the alphanumeric code (3 letters + 5 digits)
        function generateRegistrationAlphanumericCode() {
            let result = '';
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            const digits = '0123456789';

            // Generate 3 random letters
            for (let i = 0; i < 3; i++) {
                result += letters.charAt(Math.floor(Math.random() * letters.length));
            }
            // Generate 5 random digits
            for (let i = 0; i < 5; i++) {
                result += digits.charAt(Math.floor(Math.random() * digits.length));
            }
            return result;
        }

        // 事件監聽器：生成一次性註冊碼 (Owner Only)
        generateRegistrationCodeBtn.addEventListener('click', async () => {
            if (window.currentUserRole !== 'owner') {
                showMessage('權限不足', '只有管理員才能生成註冊碼。');
                return;
            }

            if (registrationCodeTimer) {
                clearInterval(registrationCodeTimer);
                registrationCodeTimer = null;
            }

            try {
                const code = generateRegistrationAlphanumericCode();
                let countdownSeconds = 60;
                const expiryDate = new Date();
                expiryDate.setSeconds(expiryDate.getSeconds() + countdownSeconds); 

                await db.collection('settings').doc('registration').set({
                    oneTimeCode: code,
                    oneTimeCodeExpiry: firebase.firestore.Timestamp.fromDate(expiryDate)
                }, { merge: true });

                registrationCodeDisplay.textContent = code;
                registrationCodeCountdown.textContent = ` (剩餘 ${countdownSeconds} 秒)`;
                registrationCodeDisplay.style.display = 'inline-block'; 
                registrationCodeCountdown.style.display = 'inline-block';
                registrationExpiryDisplay.style.display = 'none';

                registrationCodeTimer = setInterval(() => {
                    countdownSeconds--;
                    if (countdownSeconds >= 0) {
                        registrationCodeCountdown.textContent = ` (剩餘 ${countdownSeconds} 秒)`;
                    } else {
                        clearInterval(registrationCodeTimer);
                        registrationCodeTimer = null;
                        registrationCodeDisplay.textContent = '註冊碼已過期';
                        registrationCodeCountdown.style.display = 'none';
                    }
                }, 1000);
                
                const tempInput = document.createElement('textarea');
                tempInput.value = code;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);

                showMessage('成功', `一次性註冊碼已生成並複製到剪貼簿，設定為 ${countdownSeconds} 秒後過期！`);
            } catch (error) {
                console.error("生成註冊碼時出錯:", error);
                showMessage('錯誤', `生成註冊碼失敗: ${error.message}`);
            }
        });

        // 事件監聽器：重新整理用戶列表 (Owner Only)
        refreshUsersBtn.addEventListener('click', () => {
            if (window.currentUserRole === 'owner') {
                refreshUserList();
            } else {
                showMessage('權限不足', '只有管理員才能重新整理用戶列表。');
            }
        });
    });


    // ====================================================================================
    // 4. 主要 UI 互動邏輯
    // ====================================================================================

    document.addEventListener('DOMContentLoaded', () => {
        const editButton = document.getElementById('editButton');
        const authSection = document.getElementById('authSection');
        const controls = document.getElementById('controls');
        const searchBox = document.getElementById('searchBox');
        const searchResults = document.getElementById('searchResults');
        
        authSection.style.display = 'none';
        controls.style.display = 'flex';

        if (editButton && authSection && controls) {
            editButton.addEventListener('click', () => {
                const isAuthSectionVisible = authSection.style.display === 'flex';
                if (isAuthSectionVisible) {
                    authSection.style.display = 'none';
                    controls.style.display = 'flex';
                    editButton.textContent = '編輯';
                } else {
                    controls.style.display = 'none';
                    authSection.style.display = 'flex';
                    editButton.textContent = '關閉';
                }
            });
        } else {
            console.error('錯誤: 找不到編輯按鈕、認證區塊或控制項。');
        }


        // 監聽搜尋框的輸入事件
        if (searchBox && searchResults) {
            searchBox.addEventListener('input', async (e) => {
                const query = e.target.value.trim().toLowerCase();
                searchResults.innerHTML = '';

                if (query.length > 0) {
                    let results = [];
                    if (window.allKmlFeatures && window.allKmlFeatures.length > 0) {
                        results = window.allKmlFeatures.filter(feature =>
                            feature.properties && feature.properties.name && typeof feature.properties.name === 'string' && feature.properties.name.toLowerCase().includes(query)
                        );
                    }

                    // 動態定位搜尋結果框，避開左上方地圖控制項
                    const searchBoxRect = searchBox.getBoundingClientRect();
                    const mapControlsContainer = document.querySelector('.leaflet-control-container .leaflet-top.leaflet-left');
                    let controlsRightEdge = 0;

                    if (mapControlsContainer) {
                        const mapControlsRect = mapControlsContainer.getBoundingClientRect();
                        controlsRightEdge = mapControlsRect.right;
                    }
                    
                    searchResults.style.position = 'absolute';
                    searchResults.style.top = `${searchBoxRect.bottom}px`;
                    searchResults.style.left = `${Math.max(searchBoxRect.left, controlsRightEdge + 10)}px`; 
                    searchResults.style.width = `${searchBoxRect.width}px`;

                    searchResults.style.display = 'grid';

                    if (results.length === 0) {
                        const noResult = document.createElement('div');
                        noResult.className = 'result-item';
                        noResult.textContent = '沒有找到結果';
                        noResult.style.gridColumn = 'span 3'; 
                        searchResults.appendChild(noResult);
                    } else {
                        results.forEach(f => {
                            const name = f.properties.name || '未命名';
                            if (f.geometry && f.geometry.type === 'Point' && f.geometry.coordinates) {
                                const [lon, lat] = f.geometry.coordinates;
                                const item = document.createElement('div');
                                item.className = 'result-item';
                                item.textContent = name;
                                item.title = name;
                                item.addEventListener('click', () => {
                                    const originalLatLng = L.latLng(lat, lon);
                                    map.setView(originalLatLng, 16);
                                    window.createNavButton(originalLatLng, name); 
                                    searchResults.style.display = 'none';
                                    searchBox.value = '';
                                    console.log(`點擊搜尋結果: ${name}，縮放至地圖。`);
                                });
                                searchResults.appendChild(item);
                            } else {
                                console.warn("跳過非 Point 類型或無座標的 feature 進行搜尋:", f);
                            }
                        });
                    }
                } else {
                    searchResults.style.display = 'none';
                }
            });

            // 點擊搜尋結果框外部時隱藏搜尋結果
            document.addEventListener('click', (event) => {
                if (!searchResults.contains(event.target) && event.target !== searchBox) {
                    searchResults.style.display = 'none';
                }
            });

            // 監聽 ESC 鍵以隱藏搜尋結果
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    searchResults.style.display = 'none';
                    searchBox.blur();
                }
            });
        }
    });

  </script>
</body>
</html>
