<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>地圖 v4.2.7 (KML讀取與上傳優化)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />

  <style>
    /* 這裡放置所有 CSS 樣式 - 主要基於 v4.0.20 樣式，並結合新功能 */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Inter', sans-serif;
      color: #333;
    }
    body {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background-color: #f0f2f5;
    }
    #title {
      text-align: center;
      padding: 12px;
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(135deg, #6dd5ed, #2193b0);
      color: white;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      border-bottom-left-radius: 12px;
      border-bottom-right-radius: 12px;
      position: relative;
      z-index: 1001;
    }
    #editButton {
      position: absolute;
      top: 50%;
      right: 15px;
      transform: translateY(-50%);
      background-color: #f0f0f0;
      color: #333;
      padding: 8px 15px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      z-index: 1003;
    }
    #editButton:hover {
      background-color: #e0e0e0;
      transform: translateY(-50%) scale(1.03);
      box-shadow: 0 4px 8px rgba(0,0,0,0.25);
    }

    /* 認證面板樣式 - 預設隱藏，點擊編輯顯示 */
    #authSection {
      background: #fff;
      padding: 15px; /* 統一 padding */
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border-bottom: 1px solid #eee; /* 底部邊框 */
      display: none; /* 預設隱藏，由 JS 控制 */
      flex-direction: column;
      gap: 15px; /* 增加內部元素間距 */
      position: relative; /* 確保在正常文檔流中 */
      z-index: 1001; /* 確保在 controls 之上 */
    }
    #authSection h3 {
      margin: 0;
      font-size: 22px;
      color: #333;
      text-align: center;
    }
    #authSection input {
      padding: 10px 12px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #dcdcdc;
      width: calc(100% - 24px); /* 考慮 padding */
      box-sizing: border-box; /* 確保寬度包含 padding */
    }
    #loginForm, #loggedInDashboard {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    #loggedInDashboard {
        text-align: center; /* 調整為置中對齊 */
    }
    #userEmailDisplay { /* Email 顯示樣式 */
        font-size: 18px;
        font-weight: 600;
        color: #2193b0;
        margin-bottom: 5px;
        text-align: center; /* 確保 Email 自身置中 */
    }
    /* KML 管理區塊內的樣式 */
    #kmlControlsDashboard, #registrationSettingsSection, #userManagementSection {
        border-top: 1px solid #eee;
        padding-top: 10px;
        margin-top: 10px;
        display: flex; /* 確保其內部元素在有內容時能正確顯示 */
        flex-direction: column;
        gap: 10px;
    }
    /* 調整上傳和刪除按鈕佈局 */
    #uploadKmlSectionDashboard, #deleteKmlSectionDashboard {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 8px;
    }
    #uploadKmlSectionDashboard label, #deleteKmlSectionDashboard label {
        font-size: 14px;
        font-weight: 500;
        white-space: nowrap;
        flex-shrink: 0;
    }
    #selectedKmlFileNameDashboard {
        flex-grow: 1;
        font-size: 14px;
        color: #555;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        border: 1px solid #dcdcdc;
        padding: 8px 10px;
        border-radius: 6px;
        background-color: #f9f9f9;
        transition: border-color 0.3s, box-shadow 0.3s;
        box-sizing: border-box;
        height: 36px;
        display: flex;
        align-items: center;
    }
    /* 調整上傳和刪除按鈕寬度 */
    #uploadKmlSubmitBtnDashboard, #deleteSelectedKmlBtn {
        width: 80px; /* 固定按鈕寬度 */
        flex-shrink: 0; /* 防止按鈕縮小 */
    }

    /* 註冊碼顯示區域的 flex 佈局 */
    .registration-code-display-group {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap; /* 允許換行在小螢幕上 */
    }
    .registration-code-display-group button {
        flex-shrink: 0; /* 按鈕不縮小 */
    }
    #registrationCodeDisplay {
        background-color: #e6f0ff;
        padding: 8px;
        border-radius: 5px;
        word-break: break-all;
        text-align: center;
        flex-grow: 1; /* 讓代碼顯示區塊佔據剩餘空間 */
    }
    #registrationCodeDisplay.countdown-active {
        font-weight: bold;
        color: #007bff;
    }


    /* controls 樣式 - 預設顯示 */
    #controls {
      padding: 15px;
      background: #fff;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      display: flex; /* 預設顯示 */
      flex-direction: column;
      gap: 10px;
      position: relative; /* 為了 searchResults 絕對定位 */
      z-index: 1000;
    }
    /* 確保 KML 控制項預設是隱藏的，由 JS 控制顯示 */
    #kmlControls {
      display: flex; /* 內部保持 flex */
      flex-direction: column;
      gap: 10px;
    }

    #kmlInput, #searchBox, #kmlLayerSelect, #kmlLayerSelectDashboard, #registrationCodeInput { /* 統一輸入框樣式 */
      padding: 10px 12px;
      font-size: 15px;
      border-radius: 8px;
      border: 1px solid #dcdcdc;
      transition: border-color 0.3s, box-shadow 0.3s;
      width: calc(100% - 24px); /* 讓輸入框佔滿父容器寬度 */
      box-sizing: border-box;
    }
    #kmlInput:focus, #searchBox:focus, #kmlLayerSelect:focus, #kmlLayerSelectDashboard:focus {
      border-color: #4a90e2;
      box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
      outline: none;
    }
    #searchContainer {
      display: flex;
      align-items: center;
      gap: 8px;
      border: 1px solid #dcdcdc;
      border-radius: 8px;
      padding: 0 12px;
      background-color: #fff;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
      position: relative; /* 為了 searchResults 絕對定位 */
    }
    .material-symbols-outlined {
      font-variation-settings:
        'FILL' 0,
        'wght' 400,
        'GRAD' 0,
        'opsz' 24;
      font-size: 24px;
      color: #777;
      flex-shrink: 0;
      vertical-align: middle;
    }
    #searchBox {
      flex-grow: 1;
      padding: 10px 0;
      border: none;
      outline: none;
      background: transparent;
      box-sizing: border-box;
      height: 44px;
    }
    #searchResults {
      position: absolute;
      top: calc(100% + 5px); /* 緊貼搜尋框下方 */
      left: 0;
      width: 100%; /* 與搜尋框同寬 */
      max-height: 300px;
      background: rgba(255, 255, 255, 0.98);
      overflow-y: auto;
      border: 1px solid #ddd;
      border-top: none;
      border-bottom-left-radius: 8px;
      border-bottom-right-radius: 8px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.18);
      font-size: 15px;
      display: none; /* 預設隱藏，有結果才顯示 */
      z-index: 1100;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); /* 響應式網格 */
      gap: 8px;
      padding: 10px;
      box-sizing: border-box;
    }
    .result-item {
      padding: 10px 12px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      background: #fdfdfd;
      cursor: pointer;
      user-select: none;
      text-align: center;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      transition: background-color 0.2s, transform 0.2s;
    }
    .result-item:hover {
      background-color: #e6f0ff;
      transform: translateY(-2px);
    }
    #map {
      flex-grow: 1;
      border-radius: 12px;
      overflow: hidden;
      margin: 15px; /* 調整外邊距 */
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    /* Marker Label Styles */
    .marker-label {
      background: none !important;
      color: rgba(0, 0, 0, 0.88);
      font-weight: 700;
      font-size: 26px;
      text-shadow:
        -1.5px -1.5px 0 #fff,
        1.5px -1.5px 0 #fff,
        -1.5px 1.5px 0 #fff,
        1.5px 1.5px 0 #fff,
        0 0 5px rgba(0,0,0,0.1);
      padding: 0;
      transform: translate(-50%, -50%);
      pointer-events: none;
      white-space: nowrap;
      display: block;
    }
    /* Nav Button Icon Styles */
    .nav-button-icon {
        pointer-events: auto;
        background: none;
        border: none;
        box-shadow: none;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        transform: translate(-50%, -50%);
    }
    /* Actual Nav Button Content (Image) Styles */
    .nav-button-content img {
      width: 48px;
      height: 48px;
      cursor: pointer;
      display: block;
      border-radius: 50%;
      background-color: rgba(255, 255, 255, 0.8);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      transition: transform 0.2s ease-in-out;
    }
    .nav-button-content img:hover {
      transform: scale(1.1);
    }
    /* Custom Dot Icon Styles */
    .custom-dot-icon {
        background-color: #e74c3c;
        border: 2px solid white;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        pointer-events: auto;
        display: block;
        margin-left: -9px;
        margin-top: -9px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    /* Message Box Styles (統一為 modal 樣式) */
    .message-box-overlay, .registration-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .message-box-overlay.visible, .registration-modal-overlay.visible {
        opacity: 1;
        visibility: visible;
    }
    .message-box-content, .registration-modal-content {
        background: #fff;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        text-align: center;
        max-width: 400px;
        width: 90%;
        transform: translateY(-20px);
        transition: transform 0.3s ease;
    }
    .message-box-overlay.visible .message-box-content,
    .registration-modal-overlay.visible .registration-modal-content {
        transform: translateY(0);
    }
    .message-box-content h3, .registration-modal-content h3 {
        margin-top: 0;
        color: #333;
        font-size: 22px;
        margin-bottom: 15px;
    }
    .message-box-content p, .registration-modal-content p {
        color: #555;
        font-size: 16px;
        line-height: 1.6;
        margin-bottom: 25px;
    }
    .message-box-content button, .registration-modal-content button {
        background-color: #4a90e2;
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: background-color 0.2s, transform 0.2s;
    }
    .message-box-content button:hover, .registration-modal-content button:hover {
        background-color: #357ABD;
        transform: translateY(-1px);
    }
    .registration-modal-content input[type="text"] {
        padding: 10px 12px;
        font-size: 15px;
        border-radius: 8px;
        border: 1px solid #dcdcdc;
        transition: border-color 0.3s, box-shadow 0.3s;
        width: calc(100% - 24px);
        box-sizing: border-box;
        margin-bottom: 15px;
    }
    .registration-modal-content .button-group {
        display: flex;
        justify-content: center;
        gap: 15px;
    }

    /* Action Buttons (通用樣式，用於各種功能按鈕) */
    .action-buttons, .admin-option-button {
      background-color: #28a745; /* Default green */
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      transition: background-color 0.2s, transform 0.2s;
      width: 100%; /* 讓按鈕佔滿父容器寬度 */
      box-sizing: border-box;
    }
    .action-buttons:hover, .admin-option-button:hover {
      transform: translateY(-1px);
    }
    .action-buttons:disabled, .admin-option-button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    .action-buttons.google-btn { /* Google 登入按鈕 */
      background-color: #4285F4;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .action-buttons.google-btn img {
      width: 20px;
      height: 20px;
    }
    .action-buttons.upload-btn { /* 上傳 KML 按鈕 */
      background-color: #007bff;
    }
    .action-buttons.delete-btn { /* 刪除 KML 按鈕 */
      background-color: #dc3545;
    }

    /* Admin Option Buttons (Dashboard 內部按鈕) */
    .admin-option-button.upload-kml-dashboard-btn {
        background-color: #007bff; /* Blue for Upload KML */
    }
    .admin-option-button.delete-kml-dashboard-btn {
        background-color: #dc3545; /* Red for Delete KML */
    }
    .admin-option-button.add-user-dashboard-btn {
        background-color: #17a2b8; /* Info blue for Add User */
    }
    .admin-option-button.add-user-dashboard-btn:hover {
        background-color: #138496;
    }
    #addUserSection {
        border-top: 1px solid #eee;
        padding-top: 15px;
        margin-top: 15px;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    #addUserSection h4 {
        margin-top: 0;
        margin-bottom: 5px;
        font-size: 18px;
        color: #555;
    }

    /* Custom Locate Button */
    .leaflet-control-container .leaflet-top.leaflet-left {
        top: auto; /* 重置 top */
        left: 15px; /* 調整左側邊距 */
        bottom: 15px; /* 固定在底部 */
        top: initial;
    }
    .leaflet-control-locate {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .leaflet-control-locate a {
        border-radius: 8px;
        color: #4a90e2 !important;
        line-height: 30px;
        height: 30px;
        width: 30px;
    }
    .leaflet-control-locate a.active, .leaflet-control-locate a.active:hover {
        background-color: #e6f0ff;
        color: #0056b3 !important;
    }
    .leaflet-control-locate a:hover {
        background-color: #f4f4f4;
    }

    /* User Location Dot */
    .user-location-dot {
        background-color: #1a73e8;
        border: 2px solid white;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.4);
        animation: pulse 1.5s infinite ease-out;
    }
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(26, 115, 232, 0.4);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(26, 115, 232, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(26, 115, 232, 0);
        }
    }
    /* User list specific styles */
    .user-list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
    }
    .user-list-item:last-child {
        border-bottom: none;
    }
    .user-list-item span {
        flex-grow: 1;
        margin-right: 10px;
        font-size: 14px;
        color: #555;
    }
    .user-list-item select, .user-list-item button {
        margin-left: 5px;
    }
    .user-list-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }
    .user-list-table th, .user-list-table td {
        border: 1px solid #eee;
        padding: 8px;
        text-align: left;
    }
    .user-list-table th {
        background-color: #f5f5f5;
        font-weight: 600;
    }
    /* Registration Code Modal Timer */
    #registrationModalMessage.countdown {
        font-size: 16px;
        font-weight: bold;
        color: #007bff;
    }
  </style>
</head>
<body>
  <div id="title">
    我的地圖系統 v4.2.7
    <button id="editButton">編輯</button>
  </div>

  <div id="controls">
    <div style="display: flex; gap: 10px; align-items: center;">
        <label for="kmlLayerSelect" style="font-size: 15px; font-weight: 500; white-space: nowrap;">選擇資料庫圖層:</label>
        <select id="kmlLayerSelect" style="flex-grow: 1;">
            <option value="">-- 請選擇 KML 圖層 --</option>
        </select>
    </div>
    <div id="searchContainer">
        <span class="material-symbols-outlined">search</span>
        <input type="text" id="searchBox" placeholder="搜尋地點..." autocomplete="off" />
        <div id="searchResults"></div>
    </div>
  </div>

  <div id="authSection">
    <div id="loginForm">
      <h3>請登入</h3>
      <button id="googleSignInBtn" class="action-buttons google-btn">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon" />
        使用 Google 登入
      </button>
      <p id="loginMessage" style="color: red; font-size: 14px; text-align: center; margin-top: 5px;"></p>
    </div>

    <div id="loggedInDashboard" style="display: none;">
      <h3 id="userEmailDisplay" style="text-align: center; margin-bottom: 10px;"></h3> 
      
      <div id="kmlControlsDashboard">
          <div id="uploadKmlSectionDashboard">
              <label for="hiddenKmlFileInput" style="white-space: nowrap;">上傳 KML:</label>
              <input type="file" id="hiddenKmlFileInput" accept=".kml" style="display: none;" />
              <span id="selectedKmlFileNameDashboard" style="flex-grow: 1; text-align: left;">尚未選擇檔案</span>
              <button id="uploadKmlSubmitBtnDashboard" class="action-buttons upload-btn" disabled>上傳</button>
          </div>
          <div id="deleteKmlSectionDashboard">
              <label for="kmlLayerSelectDashboard" style="white-space: nowrap;">刪除 KML:</label>
              <select id="kmlLayerSelectDashboard" style="flex-grow: 1;" disabled>
                  <option value="">-- 請選擇 KML 圖層 --</option>
              </select>
              <button id="deleteSelectedKmlBtn" class="action-buttons delete-btn">刪除</button>
          </div>
      </div>

      <div id="registrationSettingsSection" style="display: none;">
          <div class="registration-code-display-group">
            <button id="generateRegistrationCodeBtn" class="action-buttons" style="background-color: #28a745;">產生一次性註冊碼</button>
            <span id="registrationCodeDisplay" style="display: none;"></span> 
          </div>
          <p id="registrationExpiryDisplay" style="display: none; font-size: 12px; color: #888; text-align: center; margin-top: -5px;"></p>
      </div>

      <div id="userManagementSection" style="display: none; margin-top: 10px;">
          <button id="refreshUsersBtn" class="action-buttons" style="background-color: #17a2b8; margin-bottom: 10px;">重新整理用戶列表</button>
          <div id="userList" style="font-size: 14px;">
          </div>
      </div>

      <button id="logoutBtn" class="action-buttons" style="background-color: #f44336; margin-top: 15px;">登出</button>
    </div>
  </div>

  <div id="map"></div>

  <div id="messageBoxOverlay" class="message-box-overlay">
    <div class="message-box-content">
      <h3 id="messageBoxTitle"></h3>
      <p id="messageBoxMessage"></p>
      <button id="messageBoxCloseBtn">確定</button>
    </div>
  </div>

  <div id="registrationCodeModalOverlay" class="registration-modal-overlay">
    <div class="registration-modal-content">
      <h3>輸入註冊碼</h3>
      <p id="registrationModalMessage">請輸入管理員提供的一次性註冊碼。</p>
      <input type="text" id="registrationCodeInput" placeholder="註冊碼" />
      <div class="button-group" style="display: flex; justify-content: center; gap: 15px;">
          <button id="confirmRegistrationCodeBtn" class="action-buttons" style="background-color: #28a745;">確認</button>
          <button id="cancelRegistrationCodeBtn" class="action-buttons" style="background-color: #6c757d;">取消</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-omnivore/0.3.4/leaflet-omnivore.min.js"></script>
  <script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js" charset="utf-8"></script>

  <script>
    // ====================================================================================
    // 1. Firebase 初始化 和 全局函數
    // ====================================================================================

    // Firebase 配置 (請替換為您自己的 Firebase 專案配置)
    // 從 Firebase Console -> 專案設定 -> 您的應用程式 -> SDK 設定與配置 中獲取
    const firebaseConfig = {
      apiKey: "AIzaSyC-uaCnvgtYacPf_7BtwbwdDUw-WMx4d8s",
      authDomain: "kmldata-d22fb.firebaseapp.com",
      projectId: "kmldata-d22fb",
      storageBucket: "kmldata-d22fb.firebasestorage.app",
      messagingSenderId: "6673236901",
      appId: "1:6673236901:web:5aac773cbb512a14b8de4c", 
      measurementId: "G-TJFH5SXNJX" 
    };

    // 初始化 Firebase
    firebase.initializeApp(firebaseConfig);

    // 獲取 Firebase 服務實例
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // 定義 showMessage 函數以便全局使用
    window.showMessage = function(title, message, callback) {
        const messageBoxOverlay = document.getElementById('messageBoxOverlay');
        const messageBoxTitle = document.getElementById('messageBoxTitle');
        const messageBoxMessage = document.getElementById('messageBoxMessage');
        const messageBoxCloseBtn = document.getElementById('messageBoxCloseBtn');

        messageBoxTitle.textContent = title;
        messageBoxMessage.textContent = message;
        messageBoxOverlay.classList.add('visible'); // 顯示彈窗

        const closeHandler = () => {
            messageBoxOverlay.classList.remove('visible'); // 隱藏彈窗
            messageBoxCloseBtn.removeEventListener('click', closeHandler);
            if (callback) {
                callback();
            }
        };
        messageBoxCloseBtn.addEventListener('click', closeHandler);
    };

    // 定義 showRegistrationCodeModal 函數以便全局使用，增加計時器功能
    window.showRegistrationCodeModal = function(callback) {
        const modalOverlay = document.getElementById('registrationCodeModalOverlay');
        const registrationCodeInput = document.getElementById('registrationCodeInput');
        const confirmBtn = document.getElementById('confirmRegistrationCodeBtn');
        const cancelBtn = document.getElementById('cancelRegistrationCodeBtn');
        const modalMessage = document.getElementById('registrationModalMessage');

        registrationCodeInput.value = ''; // 清空輸入框
        modalMessage.textContent = '請輸入管理員提供的一次性註冊碼。'; // 重設訊息
        modalMessage.classList.remove('countdown'); // 移除計時器樣式
        modalOverlay.classList.add('visible'); // 顯示模態框

        let countdown = 60; // 60秒計時 (從 30 秒修改為 60 秒)
        let timerInterval;

        const updateTimer = () => {
            modalMessage.textContent = `請輸入管理員提供的一次性註冊碼。剩餘時間: ${countdown} 秒`;
            modalMessage.classList.add('countdown');
            if (countdown <= 0) {
                clearInterval(timerInterval);
                modalOverlay.classList.remove('visible'); // 隱藏模態框
                showMessage('註冊碼過期', '註冊碼輸入時間已過，請重新註冊或聯繫管理員。');
                cleanupListeners();
                callback(null); // 表示時間到，自動取消
            }
            countdown--;
        };

        const cleanupListeners = () => {
            clearInterval(timerInterval);
            confirmBtn.removeEventListener('click', confirmHandler);
            cancelBtn.removeEventListener('click', cancelHandler);
        };

        const confirmHandler = () => {
            const code = registrationCodeInput.value.trim();
            if (code) {
                modalOverlay.classList.remove('visible'); // 隱藏模態框
                cleanupListeners();
                callback(code);
            } else {
                modalMessage.textContent = '請輸入註冊碼。';
                modalMessage.classList.remove('countdown');
            }
        };

        const cancelHandler = () => {
            modalOverlay.classList.remove('visible'); // 隱藏模態框
            cleanupListeners();
            callback(null); // 表示取消
        };

        // 啟動計時器
        timerInterval = setInterval(updateTimer, 1000);
        updateTimer(); // 立即執行一次以顯示初始時間

        confirmBtn.addEventListener('click', confirmHandler);
        cancelBtn.addEventListener('click', cancelHandler);
    };

    // ====================================================================================
    // 2. 地圖應用程式邏輯
    // ====================================================================================

    let map;
    let currentKmlLayer = null; // 用於儲存當前載入的 KML 圖層
    let markers = L.featureGroup(); // 用於儲存所有標記以便管理
    let navButtons = L.featureGroup(); // 用於儲存導航按鈕

    // 新增一個全局變數，用於儲存所有地圖上 KML Point Features 的數據，供搜尋使用
    window.allKmlFeatures = [];

    document.addEventListener('DOMContentLoaded', () => {
        // 初始化地圖
        map = L.map('map').setView([23.6, 120.9], 8); // 台灣中心經緯度

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // 添加定位控制項
        L.control.locate({
            position: 'bottomleft', // 定位按鈕位置調整
            strings: {
                title: "顯示我的位置"
            },
            locateOptions: {
                enableHighAccuracy: true,
                maxZoom: 16 // 定位後縮放級別
            },
            markerStyle: {
                className: 'user-location-dot' // 自定義用戶位置標記樣式
            },
            circleStyle: {
                color: '#1a73e8', // 藍色圈
                fillColor: '#1a73e8',
                fillOpacity: 0.15
            },
            icon: 'material-symbols-outlined',
            iconLoading: 'material-symbols-outlined'
        }).addTo(map);

        // 將 markers 和 navButtons 添加到地圖
        markers.addTo(map);
        navButtons.addTo(map);

        // 全局函數：添加標記到地圖 (修復圖層讀不到的問題)
        window.addMarkers = function(features) {
            markers.clearLayers(); // 清除現有標記
            navButtons.clearLayers(); // 清除現有導航按鈕
            features.forEach(feature => {
                // 確保 feature.geometry 和 feature.properties 存在
                if (feature.geometry && feature.geometry.coordinates && feature.properties) {
                    // 檢查 geometry 類型，只處理 Point
                    if (feature.geometry.type === 'Point') {
                        const [lon, lat] = feature.geometry.coordinates;
                        // 確保 name 屬性存在且為字串
                        const name = feature.properties.name && typeof feature.properties.name === 'string' ? feature.properties.name : '未命名地點';
                        const latlng = L.latLng(lat, lon);
                        window.createMarkerWithLabel(latlng, name);
                        window.createNavButton(latlng, name);
                    } else {
                        console.warn('Skipping non-Point feature:', feature.geometry.type, feature);
                    }
                } else {
                    console.warn('Skipping feature without geometry or properties:', feature);
                }
            });
        };

        // 全局函數：載入 KML 圖層
        window.loadKmlLayerFromFirestore = async function(kmlId) {
            if (!kmlId) {
                console.log("未提供 KML ID，不載入。");
                window.clearAllKmlLayers(); // 如果沒有選中 KML，則清除所有
                return;
            }

            // 移除現有 KML 圖層和所有標記
            window.clearAllKmlLayers();

            try {
                // 從 Firestore 獲取 KML 文件的元數據
                const doc = await db.collection('kmlLayers').doc(kmlId).get();
                if (!doc.exists) {
                    showMessage('錯誤', '找不到指定的 KML 圖層資料。');
                    console.error('KML Layer document not found for ID:', kmlId);
                    return;
                }
                const kmlData = doc.data(); // 獲取 KML 層本身的元數據

                console.log(`載入 KML Features for layer: ${kmlData.name || kmlId}`);
                showMessage('載入中', `正在載入 KML 圖層 "${kmlData.name}" 的地標，請稍候...`);

                // 從 kmlLayers/{kmlId}/features 子集合中獲取所有 GeoJSON features
                const featuresSubCollectionRef = db.collection('kmlLayers').doc(kmlId).collection('features');
                const querySnapshot = await featuresSubCollectionRef.get();
                
                const loadedFeatures = [];
                if (querySnapshot.empty) {
                    console.log(`KML 圖層 "${kmlData.name}" 的 features 子集合為空。`);
                } else {
                    querySnapshot.forEach(featureDoc => {
                        const feature = featureDoc.data();
                        // 僅處理 Point 類型的 feature，並進行基本的數據驗證
                        if (feature.geometry && feature.geometry.type === 'Point' && feature.geometry.coordinates && feature.properties) {
                            loadedFeatures.push(feature);
                        } else {
                            console.warn('Skipping invalid or non-Point feature from Firestore:', feature);
                        }
                    });
                }

                window.allKmlFeatures = loadedFeatures; // 更新全局搜尋數據
                window.addMarkers(window.allKmlFeatures); // 將地標添加到地圖

                if (window.allKmlFeatures.length > 0) {
                    // 如果有地標，設定地圖視角以包含所有地標
                    const geoJsonLayer = L.geoJSON({ type: 'FeatureCollection', features: window.allKmlFeatures });
                    if (geoJsonLayer.getBounds().isValid()) { // 檢查邊界是否有效，避免空數據導致錯誤
                        map.fitBounds(geoJsonLayer.getBounds());
                    }
                    showMessage('成功', `KML 圖層 "${kmlData.name}" 載入完成，共 ${window.allKmlFeatures.length} 個地標。`);
                } else {
                    showMessage('成功', `KML 圖層 "${kmlData.name}" 載入完成，但沒有找到地標。`);
                }

            } catch (error) {
                console.error("獲取 KML Features 或載入 KML 時出錯:", error);
                showMessage('錯誤', `無法載入 KML 圖層: ${error.message}`);
            }
        };

        // 全局函數：清除所有 KML 圖層、標記和導航按鈕
        window.clearAllKmlLayers = function() {
            if (currentKmlLayer) {
                map.removeLayer(currentKmlLayer); // 僅移除 omnivore 層
                currentKmlLayer = null;
            }
            markers.clearLayers(); // 清除所有 Leaflet 標記
            navButtons.clearLayers(); // 清除所有導航按鈕
            window.allKmlFeatures = []; // 清空搜尋數據
            console.log("所有 KML 圖層、標記和導航按鈕已清除。");
        };

        // 全局函數：創建帶有標籤的標記 (與 v4.2.2 相同，確保圖片路徑)
        window.createMarkerWithLabel = function(latlng, labelText) {
            const customIcon = L.divIcon({
                className: 'custom-dot-icon', // 使用自定義圓點樣式
                iconSize: [18, 18],
                iconAnchor: [9, 9]
            });

            const marker = L.marker(latlng, { icon: customIcon }).addTo(markers); // 添加到 markers FeatureGroup
            marker.bindTooltip(labelText, {
                permanent: true,
                direction: 'bottom',
                className: 'marker-label', // 使用自定義標籤樣式
                offset: [0, 10]
            }).openTooltip();
            return marker;
        };

        // 全局函數：創建導航按鈕 (與 v4.2.2 相同，確保圖片路徑)
        window.createNavButton = function(latlng, name) {
            const navIcon = L.divIcon({
                className: 'nav-button-icon', // 容器樣式
                html: `<div class="nav-button-content"><img src="image_ac684c.jpg" alt="導航" title="導航到 ${name}"></div>`,
                iconSize: [48, 48], // 圖標大小
                iconAnchor: [24, 24] // 圖標中心點
            });

            const navMarker = L.marker(latlng, { icon: navIcon }).addTo(navButtons); // 添加到 navButtons FeatureGroup

            // 為導航按鈕添加點擊事件
            navMarker.on('click', () => {
                const googleMapsUrl = `http://maps.google.com/maps?daddr=${latlng.lat},${latlng.lng}`; // 更正為 daddr 以導航到
                window.open(googleMapsUrl, '_blank');
            });
            return navMarker;
        };

        // 處理地圖上的點擊事件，隱藏搜尋結果
        map.on('click', () => {
            const searchResults = document.getElementById('searchResults');
            if (searchResults) {
                searchResults.style.display = 'none';
            }
            const searchBox = document.getElementById('searchBox');
            if (searchBox) {
                searchBox.value = '';
            }
        });
    });

    // ====================================================================================
    // 3. 身份驗證和 KML 管理邏輯
    // ====================================================================================

    document.addEventListener('DOMContentLoaded', () => {
        // 獲取所有相關的 DOM 元素
        const authSection = document.getElementById('authSection');
        const loginForm = document.getElementById('loginForm');
        const loggedInDashboard = document.getElementById('loggedInDashboard');
        const googleSignInBtn = document.getElementById('googleSignInBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginMessage = document.getElementById('loginMessage');
        const userEmailDisplay = document.getElementById('userEmailDisplay');

        const hiddenKmlFileInput = document.getElementById('hiddenKmlFileInput');
        const selectedKmlFileNameDashboard = document.getElementById('selectedKmlFileNameDashboard');
        const uploadKmlSubmitBtnDashboard = document.getElementById('uploadKmlSubmitBtnDashboard');
        const kmlLayerSelectDashboard = document.getElementById('kmlLayerSelectDashboard');
        const deleteSelectedKmlBtn = document.getElementById('deleteSelectedKmlBtn');

        const registrationSettingsSection = document.getElementById('registrationSettingsSection');
        const generateRegistrationCodeBtn = document.getElementById('generateRegistrationCodeBtn');
        const registrationCodeDisplay = document.getElementById('registrationCodeDisplay');
        const registrationExpiryDisplay = document.getElementById('registrationExpiryDisplay');

        const userManagementSection = document.getElementById('userManagementSection');
        const refreshUsersBtn = document.getElementById('refreshUsersBtn');
        const userListDiv = document.getElementById('userList');

        // 全局變數
        window.currentUserRole = null;
        let currentKmlLayers = []; // 用於存儲 KML 圖層的 ID 和名稱
        let registrationCodeTimer = null; // 用於儲存註冊碼計時器的實例

        // 輔助函數：更新 KML 圖層選單
        const updateKmlLayerSelects = async () => {
            const kmlLayerSelect = document.getElementById('kmlLayerSelect'); // 主地圖上的選擇器
            // 清空並重置選單
            kmlLayerSelect.innerHTML = '<option value="">-- 請選擇 KML 圖層 --</option>';
            // Dashboard 的 KML 選擇器
            const kmlLayerSelectDashboard = document.getElementById('kmlLayerSelectDashboard');
            kmlLayerSelectDashboard.innerHTML = '<option value="">-- 請選擇 KML 圖層 --</option>';
            const deleteSelectedKmlBtn = document.getElementById('deleteSelectedKmlBtn');
            if (deleteSelectedKmlBtn) deleteSelectedKmlBtn.disabled = true; // 預設禁用刪除按鈕

            // KML 選擇器始終啟用，無論登入狀態，因為所有人都必須能讀取 KML
            kmlLayerSelect.disabled = false; 
            
            // 只有 owner 或 editor 才能操作 dashboard 上的 KML 選擇器和按鈕
            const canEdit = (window.currentUserRole === 'owner' || window.currentUserRole === 'editor');
            if (kmlLayerSelectDashboard) kmlLayerSelectDashboard.disabled = !canEdit;
            if (uploadKmlSubmitBtnDashboard) uploadKmlSubmitBtnDashboard.disabled = !canEdit;


            try {
                // 修改 collection name
                const kmlRef = db.collection(`kmlLayers`); // 正確的 Firestore 集合路徑
                const snapshot = await kmlRef.get();
                currentKmlLayers = []; // 清空現有列表

                if (snapshot.empty) {
                    console.log("沒有 KML 圖層資料。");
                    return;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const kmlId = doc.id;
                    const kmlName = data.name || `KML_${kmlId.substring(0, 8)}`;
                    const option = document.createElement('option');
                    option.value = kmlId;
                    option.textContent = kmlName;
                    kmlLayerSelect.appendChild(option);

                    const optionDashboard = document.createElement('option');
                    optionDashboard.value = kmlId;
                    optionDashboard.textContent = kmlName;
                    kmlLayerSelectDashboard.appendChild(optionDashboard);

                    currentKmlLayers.push({ id: kmlId, name: kmlName });
                });

                if (currentKmlLayers.length > 0) {
                    if (canEdit && deleteSelectedKmlBtn) {
                        deleteSelectedKmlBtn.disabled = false; // 只有編輯器和擁有者才能刪除
                    }
                }

                // 為 KML 圖層選擇器添加事件監聽器（確保只添加一次，或者在每次更新時重新添加）
                kmlLayerSelect.removeEventListener('change', handleKmlLayerSelectChange); // 移除舊的
                kmlLayerSelect.addEventListener('change', handleKmlLayerSelectChange); // 添加新的


            } catch (error) {
                console.error("更新 KML 圖層列表時出錯:", error);
                showMessage('錯誤', '無法載入 KML 圖層列表。');
            }
        };

        // KML 層選擇器變更處理函數
        const handleKmlLayerSelectChange = (event) => {
            const kmlId = event.target.value;
            if (kmlId && typeof window.loadKmlLayerFromFirestore === 'function') {
                window.loadKmlLayerFromFirestore(kmlId);
            } else if (typeof window.clearAllKmlLayers === 'function') {
                window.clearAllKmlLayers(); // 如果選擇空選項則清除所有 KML
            }
        };


        // 輔助函數：顯示用戶管理列表
        const refreshUserList = async () => {
            userListDiv.innerHTML = '載入中...';
            try {
                const usersRef = db.collection('users');
                const snapshot = await usersRef.get();
                userListDiv.innerHTML = ''; // 清空

                if (snapshot.empty) {
                    userListDiv.innerHTML = '<p>目前沒有註冊用戶。</p>';
                    return;
                }

                const table = document.createElement('table');
                table.className = 'user-list-table'; // 使用新的表格樣式
                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr>
                        <th>Email</th>
                        <th>角色</th>
                        <th>動作</th>
                    </tr>
                `;
                const tbody = document.createElement('tbody');

                snapshot.forEach(doc => {
                    const user = doc.data();
                    const uid = doc.id;
                    if (uid === auth.currentUser.uid) return; // 不顯示自己

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.email || 'N/A'}</td>
                        <td>
                            <select data-uid="${uid}" class="user-role-select">
                                <option value="unapproved" ${user.role === 'unapproved' ? 'selected' : ''}>Unapproved</option>
                                <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                                <option value="editor" ${user.role === 'editor' ? 'selected' : ''}>Editor</option>
                                <option value="owner" ${user.role === 'owner' ? 'selected' : ''} ${window.currentUserRole !== 'owner' ? 'disabled' : ''}>Owner</option>
                            </select>
                        </td>
                        <td>
                            <button class="delete-user-btn action-buttons delete-btn" data-uid="${uid}" style="padding: 6px 10px; font-size: 14px;">刪除</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                table.appendChild(thead);
                table.appendChild(tbody);
                userListDiv.appendChild(table);

                // 為角色選擇器添加事件監聽器
                userListDiv.querySelectorAll('.user-role-select').forEach(select => {
                    select.addEventListener('change', async (event) => {
                        const uidToUpdate = event.target.dataset.uid;
                        const newRole = event.target.value;
                        if (newRole === 'owner' && !confirm('確定要將此用戶設定為 Owner 嗎？Owner 擁有最高權限。')) {
                            // 如果取消，將選擇器恢復為原值
                            event.target.value = event.target.dataset.originalValue;
                            return;
                        }

                        try {
                            await db.collection('users').doc(uidToUpdate).update({ role: newRole });
                            showMessage('成功', `用戶 ${uidToUpdate} 的角色已更新為 ${newRole}。`);
                            // 更新成功後，也要更新原始值
                            event.target.dataset.originalValue = newRole;
                        } catch (error) {
                            console.error("更新用戶角色時出錯:", error);
                            showMessage('錯誤', `更新用戶角色失敗: ${error.message}`);
                            // 失敗時將選擇器恢復為原值
                            event.target.value = event.target.dataset.originalValue;
                        }
                    });
                    // 保存原始值
                    select.dataset.originalValue = select.value;
                });

                // 為刪除按鈕添加事件監聽器
                userListDiv.querySelectorAll('.delete-user-btn').forEach(button => {
                    button.addEventListener('click', async (event) => {
                        const uidToDelete = event.target.dataset.uid;
                        if (confirm(`確定要刪除用戶 ${uidToDelete} 嗎？此操作不可逆！`)) {
                            try {
                                // 先刪除 Firestore 文檔
                                await db.collection('users').doc(uidToDelete).delete();
                                // 然後嘗試刪除 Authentication 中的用戶（這需要管理員 SDK，前端無法直接執行）
                                // 這一步通常在後端（Cloud Functions）完成，因為前端無法直接訪問 admin SDK
                                showMessage('成功', `用戶 ${uidToDelete} 已刪除（請確保在 Firebase Authentication 中也同步刪除）。`);
                                refreshUserList(); // 重新整理列表
                            } catch (error) {
                                console.error("刪除用戶時出錯:", error);
                                showMessage('錯誤', `刪除用戶失敗: ${error.message}`);
                            }
                        }
                    });
                });

            } catch (error) {
                console.error("載入用戶列表時出錯:", error);
                userListDiv.innerHTML = `<p style="color: red;">載入用戶列表失敗: ${error.message}</p>`;
            }
        };


        // Firestore 實時監聽器
        // 監聽用戶的權限變化
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                loginForm.style.display = 'none';
                loggedInDashboard.style.display = 'block';
                userEmailDisplay.textContent = user.email;
                userEmailDisplay.style.display = 'block'; // 確保顯示 email

                // 獲取用戶角色
                // 使用 onSnapshot 監聽用戶角色，這樣角色變更時會即時更新 UI
                db.collection('users').doc(user.uid).onSnapshot(async (doc) => {
                    if (doc.exists) {
                        const userData = doc.data();
                        window.currentUserRole = userData.role || 'unapproved'; // 新用戶預設為 unapproved

                        console.log("用戶角色:", window.currentUserRole);

                        // 根據角色禁用/啟用功能
                        const canEdit = (window.currentUserRole === 'owner' || window.currentUserRole === 'editor');
                        const isOwner = (window.currentUserRole === 'owner');

                        // Dashboard KML 功能 (僅限 editor 或 owner)
                        uploadKmlSubmitBtnDashboard.disabled = !canEdit;
                        deleteSelectedKmlBtn.disabled = !(canEdit && currentKmlLayers.length > 0);
                        kmlLayerSelectDashboard.disabled = !canEdit;

                        // 註冊設定 (Owner Only)
                        registrationSettingsSection.style.display = isOwner ? 'flex' : 'none'; 
                        generateRegistrationCodeBtn.disabled = !isOwner;
                        registrationCodeDisplay.style.display = 'none'; // 預設隱藏，點擊才顯示
                        registrationExpiryDisplay.style.display = 'none'; // 預設隱藏

                        // 用戶管理 (Owner Only)
                        userManagementSection.style.display = isOwner ? 'block' : 'none';
                        refreshUsersBtn.disabled = !isOwner;


                        if (isOwner) {
                            refreshUserList(); // 重新整理用戶列表
                        }

                        // 如果用戶是 'unapproved' 狀態，顯示提示訊息
                        if (window.currentUserRole === 'unapproved') {
                            showMessage('帳號審核中', '您的帳號正在等待管理員審核。在審核通過之前，您將無法上傳或刪除 KML。');
                        }

                        // 無論角色如何，都更新 KML 圖層選單
                        updateKmlLayerSelects();

                    } else {
                        console.log("用戶數據不存在，為新註冊用戶創建預設數據。");
                        // 如果用戶數據不存在，則可能是新註冊的用戶， Firestore 安全規則會阻止自行創建帶有 'role' 的用戶
                        // 所以這裡只會顯示登入狀態，而實際的角色會透過後端或管理員設定後才能生效
                        // 這裡可以選擇登出或者顯示一個等待審核的訊息
                        // 由於是 onAuthStateChanged 監聽，如果用戶首次登入，會自動創建帶有預設角色的文檔
                        // 所以這裡應該不會再觸發。
                        // 如果用戶文檔被刪除了，則視為未通過審核，導回登入介面
                         auth.signOut(); // 強制登出
                         showMessage('帳號資料異常', '您的帳號資料有誤或已被移除，請重新登入或聯繫管理員。');
                    }
                }, (error) => {
                    console.error("監聽用戶角色時出錯:", error);
                    showMessage('錯誤', `獲取用戶角色失敗: ${error.message}`);
                    auth.signOut(); // 監聽失敗也強制登出
                });

            } else { // 未登入狀態
                loginForm.style.display = 'block';
                loggedInDashboard.style.display = 'none';
                userEmailDisplay.textContent = '';
                userEmailDisplay.style.display = 'none';
                window.currentUserRole = null;
                updateKmlLayerSelects(); // 更新 KML 選單 (它會自動處理權限)
            }
        });

        // 事件監聽器：Google 登入/註冊
        googleSignInBtn.addEventListener('click', async () => {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const userCredential = await auth.signInWithPopup(provider);
                const user = userCredential.user;

                // 檢查用戶是否是第一次登入 (新註冊)
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (!userDoc.exists) {
                    // 新用戶，僅能透過註冊碼註冊 (因為已移除直接註冊選項)
                    await auth.signOut(); // 先登出，因為沒有註冊碼無法完成註冊
                    window.showRegistrationCodeModal(async (code) => {
                        if (code) {
                            try {
                                const regDoc = await db.collection('settings').doc('registration').get();
                                // 檢查註冊碼是否存在、是否匹配且未過期
                                if (!regDoc.exists || regDoc.data().oneTimeCode !== code || new Date() > regDoc.data().oneTimeCodeExpiry.toDate()) {
                                    showMessage('註冊失敗', '無效或過期的註冊碼。');
                                    return;
                                }
                                // 重新登入以完成註冊 (因為上次為了模態框而登出了)
                                const reAuthUserCredential = await auth.signInWithPopup(provider);
                                const reAuthUser = reAuthUserCredential.user;

                                await db.collection('users').doc(reAuthUser.uid).set({
                                    email: reAuthUser.email,
                                    role: 'unapproved',
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    registeredWithCode: true,
                                    registrationCodeUsed: code
                                });

                                // 刪除用過的一次性註冊碼
                                await db.collection('settings').doc('registration').update({
                                    oneTimeCode: firebase.firestore.FieldValue.delete(),
                                    oneTimeCodeExpiry: firebase.firestore.FieldValue.delete()
                                });

                                showMessage('註冊成功', `歡迎 ${reAuthUser.email}！您的帳號已成功註冊，正在等待管理員審核。`);

                            } catch (error) {
                                console.error("使用註冊碼登入/註冊失敗:", error);
                                showMessage('註冊失敗', `使用註冊碼登入/註冊時發生錯誤: ${error.message}`);
                            }
                        } else {
                            showMessage('取消', '您已取消註冊。');
                        }
                    });
                } else {
                    // 已存在的用戶，正常登入
                    showMessage('登入成功', `歡迎回來 ${user.email}！`);
                }
            } catch (error) {
                console.error("Google 登入失敗:", error);
                loginMessage.textContent = `登入失敗: ${error.message}`;
                showMessage('登入失敗', `Google 登入時發生錯誤: ${error.message}`);
            }
        });

        // 事件監聽器：登出
        logoutBtn.addEventListener('click', async () => {
            try {
                await auth.signOut();
                showMessage('登出成功', '您已成功登出。');
            } catch (error) {
                console.error("登出失敗:", error);
                showMessage('登出失敗', `登出時發生錯誤: ${error.message}`);
            }
        });

        // 事件監聽器：上傳 KML (Dashboard 上的按鈕，觸發文件選擇)
        uploadKmlSubmitBtnDashboard.addEventListener('click', () => {
            // 觸發隱藏的文件輸入框
            hiddenKmlFileInput.click();
        });

        // 監聽實際的文件選擇變化
        hiddenKmlFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                selectedKmlFileNameDashboard.textContent = file.name;
                uploadKmlSubmitBtnDashboard.disabled = false;
            } else {
                selectedKmlFileNameDashboard.textContent = '尚未選擇檔案';
                uploadKmlSubmitBtnDashboard.disabled = true;
            }
        });

        // 實際執行上傳 KML 的函數 (由 hiddenKmlFileInput 選擇檔案後觸發)
        uploadKmlSubmitBtnDashboard.addEventListener('click', async () => {
            const file = hiddenKmlFileInput.files[0];
            if (!file) {
                showMessage('提示', '請先選擇 KML 檔案。');
                return;
            }
            if (!auth.currentUser || (window.currentUserRole !== 'owner' && window.currentUserRole !== 'editor')) {
                showMessage('錯誤', '您沒有權限上傳 KML，請登入或等待管理員審核。');
                return;
            }

            const fileName = file.name;
            const reader = new FileReader();
            reader.onload = async () => {
                console.log(`Processing KML file: ${file.name}`);
                try {
                    const kmlString = reader.result;
                    // 使用 DOMParser 將 KML 字符串解析為 XML Document
                    const parser = new DOMParser();
                    const kmlDoc = parser.parseFromString(kmlString, 'text/xml');

                    // 檢查解析錯誤
                    if (kmlDoc.getElementsByTagName('parsererror').length > 0) {
                        const errorText = kmlDoc.getElementsByTagName('parsererror')[0].textContent;
                        throw new Error(`KML XML parsing error: ${errorText}. Please ensure your KML file is valid XML.`);
                    }

                    // 將 XML Document 傳遞給 omnivore.kml
                    const tempOmnivoreLayer = omnivore.kml(kmlDoc); 
                    if (!tempOmnivoreLayer) {
                        throw new Error("Failed to create Omnivore KML layer from parsed XML document.");
                    }
                    const geojson = tempOmnivoreLayer.toGeoJSON(); 
                    const parsedFeatures = geojson.features || []; 

                    console.log(`KML file parsed. Found ${parsedFeatures.length} features.`);

                    if (parsedFeatures.length === 0) {
                        showMessage('KML 載入', 'KML 檔案中沒有找到任何地標 (Point features)。');
                        console.warn("KML file contains no usable point features.");
                        return;
                    }

                    // 使用新的 Firestore 集合路徑
                    const kmlLayersCollectionRef = db.collection('kmlLayers');
                    const kmlLayerDocRef = await kmlLayersCollectionRef.add({
                        name: fileName,
                        uploadTime: firebase.firestore.FieldValue.serverTimestamp(),
                        uploadedBy: auth.currentUser.email || auth.currentUser.uid,
                        uploadedByRole: window.currentUserRole // 記錄上傳者角色
                    });

                    const featuresSubCollectionRef = kmlLayersCollectionRef.doc(kmlLayerDocRef.id).collection('features');
                    const batch = db.batch();
                    let addedCount = 0;
                    console.log(`Starting batch write for ${parsedFeatures.length} features.`);
                    for (const f of parsedFeatures) {
                        // 僅儲存 Point 類型的地標
                        if (f.geometry && f.properties && f.geometry.type === 'Point') {
                            batch.set(featuresSubCollectionRef.doc(), { // 自動生成 ID
                                geometry: f.geometry,
                                properties: f.properties
                            });
                            addedCount++;
                        } else {
                            console.warn("Skipping non-Point feature during upload:", f.geometry ? f.geometry.type : 'No Geometry', f);
                        }
                    }
                    await batch.commit();
                    console.log(`Batch commit successful. Added ${addedCount} features.`);

                    showMessage('成功', `KML 檔案 "${fileName}" 已成功上傳並儲存 ${addedCount} 個地標。`);
                    hiddenKmlFileInput.value = ''; // 清空檔案選擇
                    selectedKmlFileNameDashboard.textContent = '尚未選擇檔案';
                    uploadKmlSubmitBtnDashboard.disabled = true;
                    updateKmlLayerSelects(); // 更新列表
                } catch (error) {
                    console.error("Error processing KML file or uploading to Firebase:", error);
                    showMessage('KML 處理錯誤', `處理 KML 檔案或上傳時發生錯誤：${error.message}`);
                }
            };
            reader.readAsText(file);
        });


        // 事件監聽器：刪除 KML (Dashboard 上的按鈕)
        deleteSelectedKmlBtn.addEventListener('click', async () => {
            const kmlIdToDelete = kmlLayerSelectDashboard.value;
            if (!kmlIdToDelete) {
                showMessage('提示', '請先選擇要刪除的 KML 圖層。');
                return;
            }
            if (!auth.currentUser || (window.currentUserRole !== 'owner' && window.currentUserRole !== 'editor')) {
                showMessage('錯誤', '您沒有權限刪除 KML。');
                return;
            }

            if (!confirm('確定要刪除此 KML 圖層及其所有地標嗎？此操作不可逆！')) {
                return;
            }

            try {
                // 修改 collection name
                const kmlLayerDocRef = db.collection('kmlLayers').doc(kmlIdToDelete);
                const kmlDoc = await kmlLayerDocRef.get();
                if (!kmlDoc.exists) {
                    showMessage('錯誤', '找不到該 KML 圖層。');
                    return;
                }
                const kmlData = kmlDoc.data();
                const fileName = kmlData.name;

                // 刪除子集合中的所有地標
                const featuresSubCollectionRef = kmlLayerDocRef.collection('features');
                const featuresSnapshot = await featuresSubCollectionRef.get();
                const batch = db.batch();
                let deletedFeaturesCount = 0;
                featuresSnapshot.forEach(docRef => {
                    batch.delete(docRef.ref);
                    deletedFeaturesCount++;
                });
                await batch.commit();
                console.log(`Deleted ${deletedFeaturesCount} features from subcollection.`);

                // 然後刪除主 KML 圖層文檔
                await kmlLayerDocRef.delete();
                console.log(`Deleted parent KML layer document: ${kmlIdToDelete}`);
                
                showMessage('成功', `KML 圖層 "${fileName}" 已成功刪除，共刪除 ${deletedFeaturesCount} 個地標。`);
                updateKmlLayerSelects(); // 更新列表
                window.clearAllKmlLayers(); // 清除地圖上的標記
            } catch (error) {
                console.error("刪除 KML 失敗:", error);
                showMessage('刪除失敗', `刪除 KML 圖層時發生錯誤: ${error.message}`);
            }
        });

        // 事件監聽器：生成一次性註冊碼 (Owner Only)
        generateRegistrationCodeBtn.addEventListener('click', async () => {
            if (window.currentUserRole !== 'owner') {
                showMessage('權限不足', '只有管理員才能生成註冊碼。');
                return;
            }

            // 清除現有計時器（如果存在）
            if (registrationCodeTimer) {
                clearInterval(registrationCodeTimer);
                registrationCodeTimer = null;
            }

            try {
                const code = Math.random().toString(36).substring(2, 10).toUpperCase();
                let countdownSeconds = 60; // 註冊碼有效時間 60 秒
                const expiryDate = new Date();
                expiryDate.setSeconds(expiryDate.getSeconds() + countdownSeconds); 

                await db.collection('settings').doc('registration').set({
                    oneTimeCode: code,
                    oneTimeCodeExpiry: firebase.firestore.Timestamp.fromDate(expiryDate)
                }, { merge: true });

                registrationCodeDisplay.textContent = `${code} (剩餘 ${countdownSeconds} 秒)`; 
                registrationCodeDisplay.style.display = 'inline-block'; 
                registrationCodeDisplay.classList.add('countdown-active'); // 添加樣式
                registrationExpiryDisplay.style.display = 'none'; // 過期時間不再單獨顯示

                // 啟動新的計時器
                registrationCodeTimer = setInterval(() => {
                    countdownSeconds--;
                    if (countdownSeconds >= 0) {
                        registrationCodeDisplay.textContent = `${code} (剩餘 ${countdownSeconds} 秒)`;
                    } else {
                        clearInterval(registrationCodeTimer);
                        registrationCodeTimer = null;
                        registrationCodeDisplay.textContent = '註冊碼已過期';
                        registrationCodeDisplay.classList.remove('countdown-active');
                        showMessage('註冊碼過期', '一次性註冊碼已過期，請重新生成。');
                    }
                }, 1000);
                
                // 複製到剪貼簿
                const tempInput = document.createElement('textarea');
                tempInput.value = code;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);

                showMessage('成功', `一次性註冊碼已生成並複製到剪貼簿，設定為 ${countdownSeconds} 秒後過期！`);
            } catch (error) {
                console.error("生成註冊碼時出錯:", error);
                showMessage('錯誤', `生成註冊碼失敗: ${error.message}`);
            }
        });

        // 事件監聽器：重新整理用戶列表 (Owner Only)
        refreshUsersBtn.addEventListener('click', () => {
            if (window.currentUserRole === 'owner') {
                refreshUserList();
            } else {
                showMessage('權限不足', '只有管理員才能重新整理用戶列表。');
            }
        });
    });


    // ====================================================================================
    // 4. 主要 UI 互動邏輯 (恢復 v4.0.20 的行為)
    // ====================================================================================

    document.addEventListener('DOMContentLoaded', () => {
        const editButton = document.getElementById('editButton');
        const authSection = document.getElementById('authSection');
        const controls = document.getElementById('controls');
        const searchBox = document.getElementById('searchBox');
        const searchResults = document.getElementById('searchResults');
        
        // 初始狀態：controls 顯示，authSection 隱藏
        authSection.style.display = 'none'; // 預設隱藏登入/管理面板
        controls.style.display = 'flex';   // 預設顯示 KML 圖層選擇和搜尋

        // 編輯按鈕點擊事件：切換 authSection 和 controls 的顯示狀態
        if (editButton && authSection && controls) {
            editButton.addEventListener('click', () => {
                const isAuthSectionVisible = authSection.style.display === 'flex';
                if (isAuthSectionVisible) {
                    // 如果 authSection 顯示，則隱藏 authSection，顯示 controls
                    authSection.style.display = 'none';
                    controls.style.display = 'flex';
                    editButton.textContent = '編輯';
                } else {
                    // 如果 controls 顯示，則隱藏 controls，顯示 authSection
                    controls.style.display = 'none';
                    authSection.style.display = 'flex';
                    editButton.textContent = '關閉';
                }
            });
        } else {
            console.error('Error: editButton, authSection or controls not found.');
        }


        // 監聽搜尋框的輸入事件
        if (searchBox && searchResults) {
            searchBox.addEventListener('input', async (e) => {
                const query = e.target.value.trim().toLowerCase(); // 將查詢字串轉為小寫以便不區分大小寫搜尋
                searchResults.innerHTML = ''; // 清空之前的結果

                if (query.length > 0) {
                    let results = [];
                    // 從 window.allKmlFeatures 中篩選結果 
                    if (window.allKmlFeatures && window.allKmlFeatures.length > 0) {
                        results = window.allKmlFeatures.filter(feature =>
                            feature.properties && feature.properties.name && typeof feature.properties.name === 'string' && feature.properties.name.toLowerCase().includes(query)
                        );
                    }

                    searchResults.style.display = 'grid'; // 顯示為 grid

                    if (results.length === 0) {
                        const noResult = document.createElement('div');
                        noResult.className = 'result-item';
                        noResult.textContent = '沒有找到結果';
                        searchResults.appendChild(noResult);
                    } else {
                        results.forEach(f => {
                            const name = f.properties.name || '未命名';
                            // 檢查 geometry 類型，確保是 Point
                            if (f.geometry && f.geometry.type === 'Point' && f.geometry.coordinates) {
                                const [lon, lat] = f.geometry.coordinates;
                                const item = document.createElement('div');
                                item.className = 'result-item';
                                item.textContent = name;
                                item.title = name;
                                item.addEventListener('click', () => {
                                    const originalLatLng = L.latLng(lat, lon);
                                    map.setView(originalLatLng, 16);
                                    window.createNavButton(originalLatLng, name); // 使用全局函數
                                    searchResults.style.display = 'none';
                                    searchBox.value = '';
                                    console.log(`Clicked search result: ${name}, zooming to map.`);
                                });
                                searchResults.appendChild(item);
                            } else {
                                console.warn("Skipping non-Point feature or feature without coordinates for search:", f);
                            }
                        });
                    }
                } else {
                    searchResults.style.display = 'none';
                }
            });

            // 點擊搜尋結果框外部時隱藏搜尋結果
            document.addEventListener('click', (event) => {
                if (!searchResults.contains(event.target) && event.target !== searchBox) {
                    searchResults.style.display = 'none';
                }
            });

            // 監聽 ESC 鍵以隱藏搜尋結果
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    searchResults.style.display = 'none';
                    searchBox.value = ''; // 清空搜尋框
                }
            });
        }
    });

  </script>
</body>
</html>
