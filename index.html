<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>地圖 v4.2.19 (單一縮放與定位按鈕，搜尋三欄對齊，註冊碼新規則)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* 這裡放置所有 CSS 樣式 */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Inter', sans-serif;
      color: #333;
      overflow: hidden; /* 防止滾動條 */
    }

    #map {
      height: 100%;
      width: 100%;
    }

    /* 自訂控制項的基礎樣式 */
    .leaflet-control-custom {
      background-color: #fff;
      padding: 6px;
      border-radius: 8px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.4);
      cursor: pointer;
      display: flex; /* 使用 Flexbox 布局 */
      flex-direction: column; /* 垂直堆疊 */
      align-items: center; /* 水平居中 */
      gap: 5px; /* 按鈕間距 */
      z-index: 1000; /* 確保在其他元素之上 */
    }

    .leaflet-control-custom button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: background-color 0.2s;
      width: 100%; /* 讓按鈕填滿容器寬度 */
      justify-content: center; /* 水平居中內容 */
    }

    .leaflet-control-custom button:hover {
      background-color: #0056b3;
    }

    .leaflet-control-custom button:active {
      background-color: #004085;
    }

    .material-symbols-outlined {
      font-variation-settings:
        'FILL' 0,
        'wght' 400,
        'GRAD' 0,
        'opsz' 24;
      vertical-align: middle;
    }

    /* 搜尋框樣式 */
    .search-container {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 1000; /* 確保在地圖之上 */
      width: 300px; /* 搜尋框寬度 */
      max-width: 90%; /* 防止在大螢幕上過寬 */
      background-color: #fff; /* 背景色，方便看清楚邊界 */
      border-radius: 8px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.4);
      padding: 10px;
    }

    #searchBox {
      width: calc(100% - 20px); /* 減去 padding */
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 16px;
      box-sizing: border-box; /* 確保 padding 不增加寬度 */
    }

    #searchResults {
      list-style: none;
      padding: 0;
      margin: 10px 0 0 0; /* 在搜尋框下方留一點空間 */
      max-height: 400px; /* 設定最大高度 */
      overflow-y: auto; /* 超過高度時滾動 */
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      display: none; /* 預設隱藏 */
      width: 100%; /* 填滿父容器寬度 */
      box-sizing: border-box;
      /* 重要：確保搜尋結果不阻擋右側的按鈕 */
      max-width: 300px; /* 限制搜尋結果的最大寬度，與搜尋框一致 */
    }

    .search-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      display: grid; /* 使用 Grid 布局 */
      grid-template-columns: 1fr 1fr 1fr; /* 三等分欄位 */
      align-items: center;
      gap: 10px; /* 欄位間距 */
    }

    .search-item:last-child {
      border-bottom: none;
    }

    .search-item:hover {
      background-color: #f0f0f0;
    }

    .search-item-icon {
      grid-column: 1; /* 第一欄 */
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .search-item-icon .material-symbols-outlined {
      font-size: 20px;
      color: #666;
    }

    .search-item-text {
      grid-column: 2 / span 2; /* 第二、三欄合併 */
      font-size: 14px;
      color: #333;
    }

    /* 導航按鈕 */
    #navButton {
      position: absolute;
      bottom: 20px;
      left: 20px;
      z-index: 1000;
      display: none; /* 預設隱藏 */
      background-color: #28a745;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.4);
      transition: background-color 0.2s;
    }

    #navButton:hover {
      background-color: #218838;
    }

    #navButton:active {
      background-color: #1e7e34;
    }

    /* 調整 Leaflet 內建控制項的位置，如果需要 */
    /* .leaflet-control-zoom {
      top: 100px !important; // 示例：調整位置
    } */

    /* 將自訂的定位和縮放按鈕放在右下角 */
    .map-controls-bottom-right {
      position: absolute;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: flex-end; /* 右對齊 */
    }

    .map-control-button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.4);
      transition: background-color 0.2s;
    }

    .map-control-button:hover {
      background-color: #0056b3;
    }

    .map-control-button:active {
      background-color: #004085;
    }

    .map-control-button.locate {
      background-color: #ffc107; /* 黃色定位按鈕 */
      color: #333;
    }

    .map-control-button.locate:hover {
      background-color: #e0a800;
    }

    .map-control-button.locate:active {
      background-color: #c69500;
    }

    .map-control-button.zoom-in,
    .map-control-button.zoom-out {
      background-color: #6c757d; /* 灰色縮放按鈕 */
    }

    .map-control-button.zoom-in:hover,
    .map-control-button.zoom-out:hover {
      background-color: #5a6268;
    }

    .map-control-button.zoom-in:active,
    .map-control-button.zoom-out:active {
      background-color: #494f55;
    }


  </style>
</head>
<body>
  <div id="map"></div>

  <div class="search-container">
    <input type="text" id="searchBox" placeholder="搜尋地點..." />
    <ul id="searchResults" class="search-results"></ul>
  </div>

  <button id="navButton">
    <span class="material-symbols-outlined">navigation</span>
    開始導航
  </button>

  <div class="map-controls-bottom-right">
    <button id="locateButton" class="map-control-button locate">
      <span class="material-symbols-outlined">my_location</span>
      定位
    </button>
    <button id="zoomInButton" class="map-control-button zoom-in">
      <span class="material-symbols-outlined">add</span>
      放大
    </button>
    <button id="zoomOutButton" class="map-control-button zoom-out">
      <span class="material-symbols-outlined">remove</span>
      縮小
    </button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // 初始化地圖，禁用內建縮放控制項
      const map = L.map('map', {
        center: [22.6685, 120.5599], // 預設中心點 (例如：屏東內埔)
        zoom: 16,
        minZoom: 1, // 最小縮放級別
        maxZoom: 18, // 最大縮放級別
        zoomControl: false // 禁用 Leaflet 預設的縮放控制項
      });

      // 設定地圖圖層 (OpenStreetMap)
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      // 原始標記點 (如果有的話)
      let originalMarker = null;

      // 導航按鈕
      const navButton = document.getElementById('navButton');
      let currentDestination = null; // 用於儲存導航目的地

      // 創建導航按鈕的函數
      window.createNavButton = (destinationLatLng, name) => {
        currentDestination = destinationLatLng;
        navButton.style.display = 'flex'; // 顯示按鈕
        navButton.innerHTML = `<span class="material-symbols-outlined">navigation</span>開始導航至 ${name}`;
        navButton.onclick = () => {
          if (currentDestination) {
            const origin = map.getCenter(); // 使用地圖當前中心作為起點
            const url = `https://www.google.com/maps/dir/?api=1&origin=${origin.lat},${origin.lng}&destination=${currentDestination.lat},${currentDestination.lng}&travelmode=driving`;
            window.open(url, '_blank');
          }
        };
      };

      // 點擊地圖時隱藏導航按鈕 (除非是導航按鈕本身)
      map.on('click', (e) => {
        if (e.originalEvent.target !== navButton && !navButton.contains(e.originalEvent.target)) {
            navButton.style.display = 'none';
        }
      });

      // 自訂縮放按鈕
      document.getElementById('zoomInButton').addEventListener('click', () => {
        map.zoomIn();
      });

      document.getElementById('zoomOutButton').addEventListener('click', () => {
        map.zoomOut();
      });

      // 自訂定位按鈕
      document.getElementById('locateButton').addEventListener('click', () => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const lat = position.coords.latitude;
              const lng = position.coords.longitude;
              const latLng = L.latLng(lat, lng);

              // 清除舊的定位標記
              if (originalMarker) {
                map.removeLayer(originalMarker);
              }

              // 添加新的定位標記
              originalMarker = L.marker(latLng).addTo(map)
                .bindPopup("你的位置").openPopup();

              map.setView(latLng, 16); // 縮放到定位點
            },
            (error) => {
              console.error("Geolocation error:", error);
              alert("無法獲取您的位置，請檢查瀏覽器設定。");
            },
            {
              enableHighAccuracy: true,
              timeout: 5000,
              maximumAge: 0
            }
          );
        } else {
          alert("您的瀏覽器不支持地理定位。");
        }
      });


      // 搜尋功能
      const searchBox = document.getElementById('searchBox');
      const searchResults = document.getElementById('searchResults');
      let searchTimeout;

      searchBox.addEventListener('input', () => {
          clearTimeout(searchTimeout);
          const query = searchBox.value.trim();

          if (query.length > 1) {
              searchTimeout = setTimeout(async () => {
                  try {
                      // 使用 Nominatim OpenStreetMap API 進行地名搜尋
                      const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=geojson&limit=5`);
                      const data = await response.json();
                      console.log("Nominatim search results:", data);

                      searchResults.innerHTML = ''; // 清空舊的結果

                      if (data.features && data.features.length > 0) {
                          searchResults.style.display = 'block'; // 顯示結果框
                          data.features.forEach(f => {
                              // 確保是 Point 類型且有座標
                              if (f.geometry && f.geometry.type === 'Point' && f.geometry.coordinates) {
                                  const [lon, lat] = f.geometry.coordinates;
                                  const name = f.properties.display_name || '未知地點';
                                  const originalLatLng = L.latLng(lat, lon);

                                  const item = document.createElement('li');
                                  item.classList.add('search-item');
                                  item.innerHTML = `
                                      <div class="search-item-icon">
                                          <span class="material-symbols-outlined">place</span>
                                      </div>
                                      <div class="search-item-text">${name}</div>
                                  `;
                                  item.addEventListener('click', () => {
                                      // 清除舊的標記
                                      if (originalMarker) {
                                          map.removeLayer(originalMarker);
                                      }
                                      // 添加新的標記
                                      originalMarker = L.marker(originalLatLng).addTo(map)
                                          .bindPopup(name).openPopup();

                                      map.setView(originalLatLng, 16);
                                      // 點擊搜尋結果時創建導航按鈕，並清除舊的
                                      window.createNavButton(originalLatLng, name);
                                      searchResults.style.display = 'none';
                                      searchBox.value = '';
                                      console.log(`Clicked search result: ${name}, zooming to map.`);
                                  });
                                  searchResults.appendChild(item);
                              } else {
                                  console.warn("Skipping non-Point feature or feature without coordinates for search:", f);
                              }
                          });
                      } else {
                          searchResults.style.display = 'none';
                      }
                  } catch (error) {
                      console.error("搜尋地點時發生錯誤:", error);
                      searchResults.style.display = 'none';
                  }
              }, 300); // 延遲 300ms 執行搜尋
          } else {
              searchResults.style.display = 'none';
          }
      });

      // 點擊搜尋結果框外部時隱藏搜尋結果
      document.addEventListener('click', (event) => {
          if (!searchResults.contains(event.target) && event.target !== searchBox) {
              searchResults.style.display = 'none';
          }
      });

      // 監聽 ESC 鍵以隱藏搜尋結果
      document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape') {
              searchResults.style.display = 'none';
              searchBox.blur(); // 移除搜尋框的焦點
          }
      });
    });

  </script>
</body>
</html>